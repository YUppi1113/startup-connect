<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer" />
    <title>投稿一覧 - スタートアップコネクト</title>
    <link rel="stylesheet" href="styles/styles.css" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans JP", sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div id="header-placeholder"></div>
    <script src="js/loadPartials.js"></script>

    <main class="max-w-3xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
      <h1 class="text-2xl font-bold text-gray-800 mb-6">投稿一覧</h1>
      <div id="posts-container" class="bg-white rounded-lg divide-y divide-gray-200">
        <div class="px-6 py-8 text-center text-gray-500">
          <div class="h-4 bg-gray-200 rounded w-3/4 mx-auto mb-2"></div>
          <div class="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
        </div>
      </div>
    </main>

    <div id="footer-placeholder"></div>

    <script>
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__ENV__;
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      let currentUser = null;
      let currentUserProfile = null;
      let pageUser = null;

      window.addEventListener("load", async () => {
        await loadHeaderFooter();
        const params = new URLSearchParams(window.location.search);
        pageUser = params.get("user");
        await checkAuth();
        await loadPosts();
        setupRealtimeSubscriptions();
      });

      async function checkAuth() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = "login.html";
          return;
        }
        currentUser = user;
        const { data: profile } = await supabase
          .from("profiles")
          .select("first_name, last_name")
          .eq("id", currentUser.id)
          .single();
        currentUserProfile = profile;
      }

      async function loadPosts() {
        const container = document.getElementById("posts-container");

        let query = supabase
          .from("posts")
          .select("*, profiles(id, first_name, last_name, profile_image_url)")
          .order("created_at", { ascending: false });

        if (pageUser) {
          query = query.eq("user_id", pageUser);
        } else {
          const { data: follows } = await supabase
            .from("follows")
            .select("following_id")
            .eq("follower_id", currentUser.id);
          const ids = follows ? follows.map((f) => f.following_id) : [];
          if (ids.length === 0) {
            container.innerHTML =
              '<div class="px-6 py-8 text-center text-gray-500"><p class="text-sm">まだ投稿がありません</p></div>';
            return;
          }
          query = query.in("user_id", ids);
        }

        const { data: posts } = await query.limit(20);

        if (!posts || posts.length === 0) {
          container.innerHTML =
            '<div class="px-6 py-8 text-center text-gray-500"><p class="text-sm">まだ投稿がありません</p></div>';
          return;
        }

        container.innerHTML = posts
          .map((post) => {
            const images = (post.image_urls || [])
              .map((url) => `<img loading="lazy" src="${url}" class="mt-2 rounded-md">`)
              .join("");
            return `
          <div class="px-6 py-4" id="post-${post.id}">
            <div class="flex items-start space-x-3">
              <img loading="lazy" class="h-8 w-8 rounded-full object-cover" src="${
                post.profiles?.profile_image_url || "/api/placeholder/32/32"
              }" alt="${post.profiles?.last_name || ""} ${post.profiles?.first_name || ""}">
              <div class="flex-1">
                <a href="profile-detail.html?user=${post.user_id}" class="font-medium text-gray-900 hover:underline">${
              post.profiles?.last_name || ""
            } ${post.profiles?.first_name || ""}</a>
                <p class="whitespace-pre-wrap mt-1">${post.content}</p>
                ${images}
                <p class="text-xs text-gray-500 mt-1">${new Date(post.created_at).toLocaleString("ja-JP")}</p>
                <div class="text-sm text-gray-600 mt-1">いいね ${post.likes_count} ・ コメント ${post.comments_count}</div>
                <button class="text-blue-600 text-xs mr-2" onclick="likePost('${post.id}','${post.user_id}')">いいね</button>
                <div class="mt-2">
                  <input type="text" id="comment-${post.id}" class="border rounded p-1 text-sm w-full" placeholder="コメントを入力">
                  <button class="text-blue-600 text-xs mt-1" onclick="submitComment('${post.id}','${post.user_id}')">送信</button>
                </div>
              </div>
            </div>
          </div>`;
          })
          .join("");
      }

      async function likePost(postId, authorId) {
        const { error } = await supabase.from("post_likes").insert({
          user_id: currentUser.id,
          post_id: postId,
        });
        if (!error && authorId !== currentUser.id) {
          await supabase.from("notifications").insert({
            user_id: authorId,
            type: "reaction",
            title: "いいね",
            content: `${currentUserProfile.last_name} ${currentUserProfile.first_name}さんがあなたの投稿にいいねしました`,
            related_id: postId,
          });
        }
      }

      async function submitComment(postId, authorId) {
        const input = document.getElementById(`comment-${postId}`);
        const text = input.value.trim();
        if (!text) return;
        const { error } = await supabase.from("post_comments").insert({
          user_id: currentUser.id,
          post_id: postId,
          content: text,
        });
        if (!error) {
          input.value = "";
          if (authorId !== currentUser.id) {
            await supabase.from("notifications").insert({
              user_id: authorId,
              type: "comment",
              title: "コメント",
              content: `${currentUserProfile.last_name} ${currentUserProfile.first_name}さんがあなたの投稿にコメントしました`,
              related_id: postId,
            });
          }

          const mentionRegex = /@([0-9a-fA-F-]{36})/g;
          let match;
          while ((match = mentionRegex.exec(text)) !== null) {
            const mentionedId = match[1];
            if (mentionedId !== currentUser.id) {
              await supabase.from("notifications").insert({
                user_id: mentionedId,
                type: "mention",
                title: "メンション",
                content: `${currentUserProfile.last_name} ${currentUserProfile.first_name}さんがあなたをメンションしました`,
                related_id: postId,
              });
            }
          }
        }
      }

      function setupRealtimeSubscriptions() {
        supabase
          .channel("posts")
          .on(
            "postgres_changes",
            { event: "INSERT", schema: "public", table: "posts" },
            () => loadPosts()
          )
          .on(
            "postgres_changes",
            { event: "DELETE", schema: "public", table: "posts" },
            () => loadPosts()
          )
          .on(
            "postgres_changes",
            { event: "INSERT", schema: "public", table: "post_likes" },
            () => loadPosts()
          )
          .on(
            "postgres_changes",
            { event: "DELETE", schema: "public", table: "post_likes" },
            () => loadPosts()
          )
          .on(
            "postgres_changes",
            { event: "INSERT", schema: "public", table: "post_comments" },
            () => loadPosts()
          )
          .on(
            "postgres_changes",
            { event: "DELETE", schema: "public", table: "post_comments" },
            () => loadPosts()
          )
          .subscribe();
      }
    </script>
    <script src="js/theme.js"></script>
    <script src="accessibility.js"></script>
  </body>
</html>
