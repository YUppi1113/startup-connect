<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer" />
    <title>ÊäïÁ®ø‰∏ÄË¶ß - „Çπ„Çø„Éº„Éà„Ç¢„ÉÉ„Éó„Ç≥„Éç„ÇØ„Éà</title>
    <link rel="stylesheet" href="styles/styles.css" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans JP", sans-serif;
      }
    </style>
    <script type="module">
      import { showToast } from "./js/toast.js";
      import { createPost, addComment, toggleLike, toggleBookmark, subscribeToPostChanges } from "./js/post.js";
      window.showToast = showToast;
      window.createPost = createPost; window.addComment = addComment; window.toggleLike = toggleLike; window.toggleBookmark = toggleBookmark; window.subscribeToPostChanges = subscribeToPostChanges;
    </script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div id="header-placeholder"></div>
    <script src="js/loadPartials.js"></script>

    <main class="max-w-3xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
      <h1 class="text-2xl font-bold text-gray-800 mb-6">ÊäïÁ®ø‰∏ÄË¶ß</h1>
      <div class="bg-white rounded-lg shadow-sm p-4 mb-4 space-y-2">
        <textarea
          id="post-content"
          class="w-full border rounded p-2"
          rows="3"
          maxlength="280"
          placeholder="‰ªä„Å©„ÅÜ„Åó„Å¶„ÇãÔºü"
        ></textarea>
        <input
          id="post-images"
          type="file"
          accept="image/*"
          multiple
          class="block"
        />
        <div class="text-right">
          <button
            id="post-submit"
            class="bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50"
          >ÊäïÁ®ø</button>
        </div>
      </div>
      <div id="posts-container" class="bg-white rounded-lg divide-y divide-gray-200">
        <div class="px-6 py-8 text-center text-gray-500">
          <div class="h-4 bg-gray-200 rounded w-3/4 mx-auto mb-2"></div>
          <div class="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
        </div>
      </div>
    </main>

    <div id="footer-placeholder"></div>

    <script>
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__ENV__;
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      let currentUser = null;
      let pageUser = null;

      window.addEventListener("load", async () => {
        await loadHeaderFooter();
        const params = new URLSearchParams(window.location.search);
        pageUser = params.get("user");
        await checkAuth();
        await loadPosts();
        document
          .getElementById("post-submit")
          ?.addEventListener("click", handleCreatePost);
      });

      async function checkAuth() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = "login.html";
          return;
        }
        currentUser = user;
      }

      async function loadPosts() {
        const container = document.getElementById("posts-container");

        let query = supabase
          .from("posts")
          .select(
            "*, profiles(id, first_name, last_name, profile_image_url), post_comments(id, content, created_at, profiles!post_comments_user_id_fkey(id, first_name, last_name, profile_image_url))"
          )
          .order("created_at", { ascending: false });

        if (pageUser) {
          query = query.eq("user_id", pageUser);
        } else {
          const { data: follows } = await supabase
            .from("follows")
            .select("following_id")
            .eq("follower_id", currentUser.id);
          const ids = follows ? follows.map((f) => f.following_id) : [];
          if (ids.length === 0) {
            container.innerHTML =
              '<div class="px-6 py-8 text-center text-gray-500"><p class="text-sm">„Åæ„Å†ÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>';
            return;
          }
          query = query.in("user_id", ids);
        }

        const { data: posts } = await query.limit(20);

        if (!posts || posts.length === 0) {
          container.innerHTML =
            '<div class="px-6 py-8 text-center text-gray-500"><p class="text-sm">„Åæ„Å†ÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>';
          return;
        }

        const ids = posts.map((p) => p.id);
        const [{ data: likes }, { data: bookmarks }] = await Promise.all([
          supabase
            .from("post_likes")
            .select("post_id")
            .eq("user_id", currentUser.id)
            .in("post_id", ids),
          supabase
            .from("post_bookmarks")
            .select("post_id")
            .eq("user_id", currentUser.id)
            .in("post_id", ids),
        ]);
        const likedIds = likes ? likes.map((l) => l.post_id) : [];
        const bookmarkedIds = bookmarks ? bookmarks.map((b) => b.post_id) : [];

        container.innerHTML = posts
          .map((post) => {
            const images = (post.image_urls || [])
              .map((url) => `<img loading="lazy" src="${url}" class="mt-2 rounded-md">`)
              .join("");
            const comments = (post.post_comments || [])
              .map(
                (c) => `
                <div class="flex items-start space-x-2 mt-2 text-sm">
                  <img loading="lazy" src="${
                    c.profiles?.profile_image_url || "/api/placeholder/24/24"
                  }" class="w-6 h-6 rounded-full object-cover" />
                  <div>
                    <p class="font-medium">${c.profiles?.last_name || ""} ${
      c.profiles?.first_name || ""
    } <span class="text-xs text-gray-500 ml-1">${new Date(c.created_at).toLocaleDateString(
      "ja-JP"
    )}</span></p>
                    <p>${c.content}</p>
                  </div>
                </div>
              `
              )
              .join("");
            const liked = likedIds.includes(post.id);
            const bookmarked = bookmarkedIds.includes(post.id);
            return `
          <div class="px-6 py-4" data-post="${post.id}">
            <div class="flex items-start space-x-3">
              <img loading="lazy" class="h-8 w-8 rounded-full object-cover" src="${
                post.profiles?.profile_image_url || "/api/placeholder/32/32"
              }" alt="${post.profiles?.last_name || ""} ${post.profiles?.first_name || ""}">
              <div class="flex-1">
                <a href="profile-detail.html?user=${post.user_id}" class="font-medium text-gray-900 hover:underline">${
              post.profiles?.last_name || ""
            } ${post.profiles?.first_name || ""}</a>
                <p class="whitespace-pre-wrap mt-1">${post.content}</p>
                ${images}
                <div class="flex space-x-4 text-sm text-gray-600 mt-1">
                  <button class="like-btn" data-id="${post.id}" aria-pressed="${liked}">‚ù§Ô∏è <span>${post.likes_count}</span></button>
                  <button class="bookmark-btn" data-id="${post.id}" aria-pressed="${bookmarked}">üîñ</button>
                  <span>„Ç≥„É°„É≥„Éà ${post.comments_count}</span>
                </div>
                <div class="mt-2 space-y-2 comment-list">${comments}</div>
                <div class="mt-2 flex space-x-2">
                  <input data-comment-input="${post.id}" class="comment-input flex-1 border rounded p-1 text-sm" placeholder="„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ">
                  <button data-comment-submit="${post.id}" class="comment-submit text-blue-600 text-sm">ÈÄÅ‰ø°</button>
                </div>
                <p class="text-xs text-gray-500 mt-1">${new Date(post.created_at).toLocaleString('ja-JP')}</p>
              </div>
            </div>
          </div>`;
          })
          .join("");
        attachPostEvents();
      }

      const MAX_TEXT = 280;
      const MAX_IMAGES = 4;

      async function handleCreatePost() {
        const contentEl = document.getElementById("post-content");
        const filesEl = document.getElementById("post-images");
        const content = contentEl.value.trim();
        const files = Array.from(filesEl.files || []);
        if (content.length === 0 && files.length === 0) return;
        if (content.length > MAX_TEXT) {
          window.showToast && window.showToast(`ÊúÄÂ§ß${MAX_TEXT}ÊñáÂ≠ó„Åæ„Åß„Åß„Åô`, "error");
          return;
        }
        if (files.length > MAX_IMAGES) {
          window.showToast && window.showToast(`ÁîªÂÉè„ÅØ${MAX_IMAGES}Êûö„Åæ„Åß„Åß„Åô`, "error");
          return;
        }
        try {
          await window.createPost(supabase, content, files);
          contentEl.value = "";
          filesEl.value = "";
          await loadPosts();
          window.showToast && window.showToast("ÊäïÁ®ø„Åó„Åæ„Åó„Åü", "success");
        } catch (e) {
          console.error(e);
          window.showToast && window.showToast("ÊäïÁ®ø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü", "error");
        }
      }

      function attachPostEvents() {
        document.querySelectorAll('.like-btn').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const postId = btn.dataset.id;
            const res = await window.toggleLike(supabase, postId);
            btn.setAttribute('aria-pressed', res.liked);
            btn.querySelector('span').textContent = res.count;
          });
        });
        document.querySelectorAll('.bookmark-btn').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const postId = btn.dataset.id;
            const on = await window.toggleBookmark(supabase, postId);
            btn.setAttribute('aria-pressed', on);
          });
        });
        document.querySelectorAll('.comment-submit').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const postId = btn.dataset.id;
            const input = document.querySelector(`[data-comment-input="${postId}"]`);
            const text = input.value.trim();
            if (!text) return;
            await window.addComment(supabase, postId, text);
            input.value = '';
            await loadPosts();
          });
        });
      }

      window.subscribeToPostChanges(supabase, {
        insert: loadPosts,
        delete: loadPosts,
        likeInsert: loadPosts,
        likeDelete: loadPosts,
        commentInsert: loadPosts,
      });
    </script>
    <script src="js/theme.js"></script>
    <script src="accessibility.js"></script>
  </body>
</html>
