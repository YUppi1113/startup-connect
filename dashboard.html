<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer" />
    <title>ダッシュボード - スタートアップコネクト</title>
    <link rel="stylesheet" href="styles/styles.css" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans JP", sans-serif;
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 5px;
      }
      .scrollbar-thin::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 5px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }
      .guide-bubble {
        position: relative;
        background: #f3f4f6;
        border-radius: 0.5rem;
        padding: 1rem;
      }
      .guide-bubble::after {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 1.5rem;
        border-width: 8px;
        border-style: solid;
    border-color: #f3f4f6 transparent transparent transparent;
      }
    </style>
    <script type="module">
      import { showToast } from "./js/toast.js";
      import { registerPush } from "./js/push.js";
      window.showToast = showToast;
      window.registerPush = registerPush;
    </script>
  </head>
  <body class="bg-gray-50 dark:bg-dark-bg dark:text-dark-text min-h-screen">
    <!-- ヘッダー -->
    <div id="header-placeholder"></div>
    <script src="js/loadPartials.js"></script>


    <!-- メインコンテンツ -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
      <!-- ウェルカムセクション -->
      <div class="mb-8">
        <h1 id="welcome-message" class="text-2xl font-bold text-gray-900">
          こんにちは！
        </h1>
        <p class="text-gray-600">
          今日は何を探していますか？ビジネスパートナー、新しいアイデア、それとも知識の共有？
        </p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- 左カラム：アクティビティとお知らせ -->
        <div class="lg:col-span-2 space-y-6">
          <!-- 新着通知 -->
          <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-800">最新の通知</h2>
            </div>
            <div
              id="notifications-container"
              class="divide-y divide-gray-200 max-h-96 overflow-y-auto"
            >
              <!-- 通知はJavaScriptで動的に生成 -->
              <div class="px-6 py-8 text-center text-gray-500 skeleton">
                <div class="h-4 bg-gray-200 rounded w-3/4 mx-auto mb-2"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
              </div>
            </div>
            <div class="px-6 py-3 bg-gray-50 text-center">
              <a
                href="notifications.html"
                class="text-sm text-blue-600 hover:underline"
                >すべての通知を見る</a
              >
            </div>
          </div>

          <!-- 新着メッセージ -->
          <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-800">
                最新のメッセージ
              </h2>
            </div>
            <div id="messages-container" class="divide-y divide-gray-200">
              <!-- メッセージはJavaScriptで動的に生成 -->
              <div class="px-6 py-8 text-center text-gray-500 skeleton">
                <div class="h-4 bg-gray-200 rounded w-3/4 mx-auto mb-2"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
              </div>
            </div>
            <div class="px-6 py-3 bg-gray-50 text-center">
              <a
                href="messages.html"
                class="text-sm text-blue-600 hover:underline"
                >すべてのメッセージを見る</a
              >
            </div>
          </div>

          <!-- 参加中のグループ -->
          <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-800">
                参加中のグループ
              </h2>
            </div>
            <div id="groups-container" class="divide-y divide-gray-200">
              <!-- グループはJavaScriptで動的に生成 -->
              <div class="px-6 py-8 text-center text-gray-500 skeleton">
                <div class="h-4 bg-gray-200 rounded w-3/4 mx-auto mb-2"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
              </div>
            </div>
            <div class="px-6 py-3 bg-gray-50 flex justify-between items-center">
              <a
                href="groups.html"
                class="text-sm text-blue-600 hover:underline"
                >すべてのグループを見る</a
              >
              <a
                href="groups.html#create"
                class="text-sm text-blue-600 hover:underline flex items-center"
              >
                <svg
                  class="h-4 w-4 mr-1"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  />
                </svg>
                新規グループを作成
              </a>
            </div>
          </div>

          <!-- 直近のイベント -->
          <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-800">
                直近のイベント
              </h2>
            </div>
            <div id="events-container" class="divide-y divide-gray-200">
              <!-- イベントはJavaScriptで動的に生成 -->
              <div class="px-6 py-8 text-center text-gray-500 skeleton">
                <div class="h-4 bg-gray-200 rounded w-3/4 mx-auto mb-2"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
              </div>
            </div>
            <div class="px-6 py-3 bg-gray-50 text-center">
              <a
                href="events.html"
                class="text-sm text-blue-600 hover:underline"
                >すべてのイベントを見る</a
              >
            </div>
          </div>
        </div>

        <!-- 右カラム：おすすめユーザーとクイックアクセス -->
        <div class="space-y-6">
          <!-- ユーザープロフィールカード -->
          <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div id="profile-card" class="p-6 flex flex-col items-center">
              <div class="skeleton h-24 w-24 rounded-full mb-4"></div>
              <div class="skeleton h-6 w-32 mb-2"></div>
              <div class="skeleton h-4 w-24 mb-3"></div>
              <div class="skeleton h-10 w-full"></div>
            </div>
            <div
              id="profile-stats"
              class="px-6 py-4 bg-gray-50 flex justify-around text-center border-t border-gray-200"
            >
              <div>
                <p class="text-xl font-semibold text-gray-900">-</p>
                <p class="text-sm text-gray-500">フォロー中</p>
              </div>
              <div class="border-l border-gray-300"></div>
              <div>
                <p class="text-xl font-semibold text-gray-900">-</p>
                <p class="text-sm text-gray-500">フォロワー</p>
              </div>
              <div class="border-l border-gray-300"></div>
              <div>
                <p class="text-xl font-semibold text-gray-900">-</p>
                <p class="text-sm text-gray-500">グループ</p>
              </div>
            </div>
          </div>

          <!-- おすすめユーザー -->
          <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-800">
                おすすめのユーザー
              </h2>
            </div>
            <div id="recommended-users" class="divide-y divide-gray-200">
              <!-- おすすめユーザーはJavaScriptで動的に生成 -->
              <div class="px-6 py-8 text-center text-gray-500 skeleton">
                <div class="h-4 bg-gray-200 rounded w-3/4 mx-auto mb-2"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
              </div>
            </div>
            <div class="px-6 py-3 bg-gray-50 text-center">
              <a
                href="search.html"
                class="text-sm text-blue-600 hover:underline"
                >もっとユーザーを探す</a
              >
            </div>
          </div>

          <!-- クイックアクセス -->
          <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-800">
                クイックアクセス
              </h2>
            </div>
            <div class="p-6 grid grid-cols-2 gap-4">
              <a
                href="search.html"
                class="bg-blue-50 p-4 rounded-lg text-center hover:bg-blue-100 transition duration-200"
              >
                <svg
                  class="h-8 w-8 text-blue-600 mx-auto"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  />
                </svg>
                <p class="mt-2 text-sm font-medium text-gray-900">
                  ユーザー検索
                </p>
              </a>
              <a
                href="messages.html"
                class="bg-green-50 p-4 rounded-lg text-center hover:bg-green-100 transition duration-200"
              >
                <svg
                  class="h-8 w-8 text-green-600 mx-auto"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                  />
                </svg>
                <p class="mt-2 text-sm font-medium text-gray-900">メッセージ</p>
              </a>
              <a
                href="groups.html"
                class="bg-purple-50 p-4 rounded-lg text-center hover:bg-purple-100 transition duration-200"
              >
                <svg
                  class="h-8 w-8 text-purple-600 mx-auto"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                  />
                </svg>
                <p class="mt-2 text-sm font-medium text-gray-900">グループ</p>
              </a>
              <a
                href="events.html"
                class="bg-yellow-50 p-4 rounded-lg text-center hover:bg-yellow-100 transition duration-200"
              >
                <svg
                  class="h-8 w-8 text-yellow-600 mx-auto"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  />
                </svg>
                <p class="mt-2 text-sm font-medium text-gray-900">イベント</p>
              </a>
            </div>
          </div>
        </div>

      </div>
  </main>

    <!-- 使い方ガイドモーダル -->
    <div id="guide-modal" class="fixed inset-0 z-30 hidden" role="dialog" aria-modal="true">
      <div class="absolute inset-0 bg-gray-900 bg-opacity-50"></div>
      <div class="relative max-w-lg mx-auto mt-20 bg-white rounded-lg shadow-xl">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-semibold text-gray-900">使い方ガイド</h3>
            <button id="close-guide-modal" class="text-gray-400 hover:text-gray-500">
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div id="guide-step" class="guide-bubble text-gray-700 mb-4">
            <p id="guide-step-text"></p>
          </div>
          <div class="flex justify-between">
            <button id="guide-prev" class="text-blue-600 hover:underline" disabled>戻る</button>
            <button id="guide-next" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">次へ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 初回説明モーダル -->
    <div id="intro-modal" class="fixed inset-0 z-40 hidden" role="dialog" aria-modal="true">
      <div class="absolute inset-0 bg-gray-900 bg-opacity-50"></div>
      <div class="relative max-w-md mx-auto mt-20 bg-white rounded-lg shadow-xl p-6">
        <h2 class="text-xl font-semibold mb-4">スタートアップコネクトへようこそ</h2>
        <ol class="list-decimal list-inside space-y-2 text-gray-700">
          <li>プロフィールを完成させましょう。</li>
          <li>検索からパートナーを探しましょう。</li>
          <li>メッセージを送って交流しましょう。</li>
        </ol>
        <div class="mt-6 text-right">
          <button id="intro-close-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">はじめる</button>
        </div>
      </div>
    </div>

    <!-- フッター -->
    <div id="footer-placeholder"></div>

    <script>
      // Supabase設定
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__ENV__;
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // グローバル変数
      let currentUser = null;
      let userProfile = null;

      // 地域名マッピング
      const locationNames = {
        hokkaido: "北海道",
        aomori: "青森県",
        iwate: "岩手県",
        miyagi: "宮城県",
        akita: "秋田県",
        yamagata: "山形県",
        fukushima: "福島県",
        ibaraki: "茨城県",
        tochigi: "栃木県",
        gunma: "群馬県",
        saitama: "埼玉県",
        chiba: "千葉県",
        tokyo: "東京都",
        kanagawa: "神奈川県",
        niigata: "新潟県",
        toyama: "富山県",
        ishikawa: "石川県",
        fukui: "福井県",
        yamanashi: "山梨県",
        nagano: "長野県",
        gifu: "岐阜県",
        shizuoka: "静岡県",
        aichi: "愛知県",
        mie: "三重県",
        shiga: "滋賀県",
        kyoto: "京都府",
        osaka: "大阪府",
        hyogo: "兵庫県",
        nara: "奈良県",
        wakayama: "和歌山県",
        tottori: "鳥取県",
        shimane: "島根県",
        okayama: "岡山県",
        hiroshima: "広島県",
        yamaguchi: "山口県",
        tokushima: "徳島県",
        kagawa: "香川県",
        ehime: "愛媛県",
        kochi: "高知県",
        fukuoka: "福岡県",
        saga: "佐賀県",
        nagasaki: "長崎県",
        kumamoto: "熊本県",
        oita: "大分県",
        miyazaki: "宮崎県",
        kagoshima: "鹿児島県",
        okinawa: "沖縄県",
      };

      const ageNames = {
        "10s": "10代",
        "20s": "20代",
        "30s": "30代",
        "40s": "40代",
        "50s": "50代",
        "60s": "60代以上",
      };

      const skillNames = {
        tech: "テクノロジー・IT",
        marketing: "マーケティング",
        sales: "営業・セールス",
        finance: "財務・会計",
        design: "デザイン",
        hr: "人事・組織開発",
        legal: "法務・知財",
        planning: "企画・戦略",
        other: "その他",
      };

      // ページ読み込み時の初期化
      window.addEventListener("load", async () => {
        await loadHeaderFooter();
        if (window.initI18n) window.initI18n();
        // ヘッダー関連のイベント
        document
          .querySelector(".mobile-menu-button")
          ?.addEventListener("click", function () {
            const menu = document.getElementById("mobile-menu");
            const expanded = menu.classList.toggle("hidden") ? false : true;
            this.setAttribute("aria-expanded", expanded);
          });

        document
          .getElementById("user-menu-button")
          ?.addEventListener("click", function () {
            const menu = document.getElementById("user-menu");
            const expanded = menu.classList.toggle("hidden") ? false : true;
            this.setAttribute("aria-expanded", expanded);
          });

        window.addEventListener("click", function (e) {
          const btn = document.getElementById("user-menu-button");
          if (btn && !btn.contains(e.target)) {
            document.getElementById("user-menu")?.classList.add("hidden");
            btn.setAttribute("aria-expanded", false);
          }
        });

        document
          .getElementById("logout-link")
          ?.addEventListener("click", async (e) => {
            e.preventDefault();
            await supabase.auth.signOut();
            window.location.href = "login.html?message=logout";
          });

        document
          .querySelector(".logout-link-mobile")
          ?.addEventListener("click", async (e) => {
            e.preventDefault();
            await supabase.auth.signOut();
            window.location.href = "login.html?message=logout";
          });

        document.getElementById("guide-link")?.addEventListener("click", (e) => {
          e.preventDefault();
          guideIndex = 0;
          showGuideStep(guideIndex);
          openModal("guide-modal", e.currentTarget);
        });
        document
          .getElementById("guide-link-mobile")
          ?.addEventListener("click", (e) => {
            e.preventDefault();
            guideIndex = 0;
            showGuideStep(guideIndex);
            openModal("guide-modal", e.currentTarget);
        });
        document
          .getElementById("guide-link-footer")
          ?.addEventListener("click", (e) => {
            e.preventDefault();
            guideIndex = 0;
            showGuideStep(guideIndex);
            openModal("guide-modal", e.currentTarget);
        });

        await checkAuth();
        await loadDashboardData();
        // 投稿機能は削除
        setupRealtimeSubscriptions();

        if (window.registerPush && window.__ENV__ && window.__ENV__.PUSH_VAPID_PUBLIC_KEY) {
          const { data: subs } = await supabase
            .from("push_subscriptions")
            .select("id")
            .eq("user_id", currentUser.id);
          if (!subs || subs.length === 0) {
            if (Notification.permission === "granted") {
              await window.registerPush(currentUser.id);
            } else if (window.showToast) {
              window.showToast(
                "通知が無効です。設定から有効にしてください。",
                "info"
              );
            }
          }
        }

        if (!localStorage.getItem("introShown")) {
          openModal("intro-modal");
        }
        document
          .getElementById("intro-close-btn")
          .addEventListener("click", () => {
            localStorage.setItem("introShown", "true");
            closeModal("intro-modal");
          });
      });

      // 認証チェック
      async function checkAuth() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = "login.html";
          return;
        }
        currentUser = user;
        await loadUserProfile();
      }

      // ユーザープロフィール読み込み
      async function loadUserProfile() {
        const { data: profile } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", currentUser.id)
          .single();

        if (profile) {
          userProfile = profile;
          updateUserInfo(profile);
          updateWelcomeMessage(profile);
          updateProfileCard(profile);
        }
      }

      // ユーザー情報更新
      function updateUserInfo(profile) {
        document.getElementById(
          "user-name"
        ).textContent = `${profile.last_name} ${profile.first_name}`;
        document.getElementById("user-location").textContent =
          locationNames[profile.location] || profile.location;
        if (profile.profile_image_url) {
          document.getElementById("user-avatar").src =
            profile.profile_image_url;
        }
      }

      // ウェルカムメッセージ更新
      function updateWelcomeMessage(profile) {
        const hour = new Date().getHours();
        let greeting = "こんにちは";
        if (hour < 10) greeting = "おはようございます";
        else if (hour >= 18) greeting = "こんばんは";

        document.getElementById(
          "welcome-message"
        ).textContent = `${greeting}、${profile.last_name}さん！`;
      }

      // プロフィールカード更新
      function updateProfileCard(profile) {
        const profileCard = document.getElementById("profile-card");
        profileCard.innerHTML = `
                <img loading="lazy" src="${
                  profile.profile_image_url || "/api/placeholder/96/96"
                }" alt="${profile.last_name} ${
          profile.first_name
        }" class="h-24 w-24 rounded-full object-cover">
                <h2 class="mt-4 text-xl font-semibold text-gray-900">${
                  profile.last_name
                } ${profile.first_name}</h2>
                <p class="text-sm text-gray-500">${
                  locationNames[profile.location] || profile.location
                }・${ageNames[profile.age_range] || profile.age_range}</p>
                <div class="mt-3 flex flex-wrap justify-center gap-1">
                    ${profile.skills
                      .slice(0, 3)
                      .map(
                        (skill) => `
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${skillNames[skill] || skill}
                        </span>
                    `
                      )
                      .join("")}
                </div>
                <div class="mt-6 w-full">
                    <a href="profile.html" class="block w-full text-center bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition duration-200">プロフィールを編集</a>
                </div>
            `;
      }

      // ダッシュボードデータ読み込み
      async function loadDashboardData() {
        await Promise.all([
          loadNotifications(),
          loadMessages(),
          loadFollowRequestCount(),
          loadGroups(),
          loadEvents(),
          loadStats(),
          loadRecommendedUsers(),
        ]);
      }

      // 通知読み込み
      async function loadNotifications() {
        const { data: notifications } = await supabase
          .from("notifications")
          .select("*")
          .eq("user_id", currentUser.id)
          .order("created_at", { ascending: false })
          .limit(5);

        const container = document.getElementById("notifications-container");

        if (!notifications || notifications.length === 0) {
          container.innerHTML = `
                    <div class="px-6 py-8 text-center text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">通知はありません</h3>
                        <p class="mt-1 text-sm text-gray-500">新しい通知が届くとここに表示されます。</p>
                    </div>
                `;
          return;
        }

        const unreadCount = notifications.filter((n) => !n.is_read).length;
        if (unreadCount > 0) {
          document
            .getElementById("notification-dot")
            .classList.remove("hidden");
        }

        container.innerHTML = notifications
          .map((notification) => {
            const iconColor =
              notification.type === "follow"
                ? "blue"
                : notification.type === "message"
                ? "green"
                : notification.type === "event"
                ? "purple"
                : "yellow";

            const icon =
              notification.type === "follow"
                ? `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />`
                : notification.type === "message"
                ? `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />`
                : notification.type === "event"
                ? `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />`
                : `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>`;

            return `
                    <div class="px-6 py-4 flex items-start hover:bg-gray-50 cursor-pointer ${
                      !notification.is_read ? "bg-blue-50" : ""
                    }" onclick="markAsRead('${notification.id}')">
                        <div class="flex-shrink-0 mr-4">
                            <div class="h-10 w-10 rounded-full bg-${iconColor}-100 flex items-center justify-center">
                                <svg class="h-6 w-6 text-${iconColor}-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    ${icon}
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-800">${
                              notification.content
                            }</p>
                            <span class="text-xs text-gray-500">${formatTime(
                              notification.created_at
                            )}</span>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // メッセージ読み込み
      async function loadMessages() {
        const { data: messages } = await supabase
          .from("direct_messages")
          .select(
            `
                    *,
                    sender:profiles!direct_messages_sender_id_fkey(*)
                `
          )
          .eq("receiver_id", currentUser.id)
          .order("created_at", { ascending: false })
          .limit(5);

        const container = document.getElementById("messages-container");

        if (!messages || messages.length === 0) {
          container.innerHTML = `
                    <div class="px-6 py-8 text-center text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">メッセージはありません</h3>
                        <p class="mt-1 text-sm text-gray-500">新しいメッセージが届くとここに表示されます。</p>
                    </div>
                `;
          return;
        }

        const unreadCount = messages.filter((m) => !m.is_read).length;
        if (unreadCount > 0) {
          document.getElementById("message-badge").classList.remove("hidden");
          document.getElementById("message-badge").textContent = unreadCount;
        }

        container.innerHTML = messages
          .map(
            (message) => `
                <div class="px-6 py-4 flex items-start hover:bg-gray-50 transition duration-150 cursor-pointer" onclick="window.location.href='messages.html?user=${
                  message.sender_id
                }';">
                    <div class="flex-shrink-0 mr-4">
                        <img loading="lazy" class="h-10 w-10 rounded-full object-cover" src="${
                          message.sender.profile_image_url ||
                          "/api/placeholder/40/40"
                        }" alt="${message.sender.last_name} ${
              message.sender.first_name
            }">
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <p class="text-sm font-medium text-gray-900">${
                              message.sender.last_name
                            } ${message.sender.first_name}</p>
                            <span class="text-xs text-gray-500">${formatTime(
                              message.created_at
                            )}</span>
                        </div>
                        <p class="text-sm text-gray-600 truncate ${
                          !message.is_read ? "font-semibold" : ""
                        }">${message.content}</p>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // フォローリクエスト数読み込み
      async function loadFollowRequestCount() {
        const { count } = await supabase
          .from("follow_requests")
          .select("*", { count: "exact", head: true })
          .eq("target_id", currentUser.id)
          .eq("status", "pending");
        const badge = document.getElementById("request-badge");
        if (count && count > 0) {
          badge.classList.remove("hidden");
          badge.textContent = count;
        } else {
          badge.classList.add("hidden");
        }
      }

      // グループ読み込み
      async function loadGroups() {
        const { data: groups } = await supabase
          .from("group_members")
          .select(
            `
                    group_id,
                    groups!inner(
                        *,
                        group_messages(
                            *,
                            user:profiles!group_messages_user_id_fkey(*)
                        )
                    )
                `
          )
          .eq("user_id", currentUser.id)
          .order("groups.group_messages.created_at", { ascending: false })
          .limit(5);

        const groupIds = groups ? groups.map((g) => g.group_id) : [];
        const unreadCounts = {};
        if (groupIds.length > 0) {
          const { data: unreadMessages } = await supabase
            .from("group_messages")
            .select("group_id")
            .eq("is_read", false)
            .eq("user_id", currentUser.id)
            .in("group_id", groupIds);

          (unreadMessages || []).forEach((msg) => {
            unreadCounts[msg.group_id] = (unreadCounts[msg.group_id] || 0) + 1;
          });
        }

        const container = document.getElementById("groups-container");

        if (!groups || groups.length === 0) {
          container.innerHTML = `
                    <div class="px-6 py-8 text-center text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">グループに参加していません</h3>
                        <p class="mt-1 text-sm text-gray-500">グループに参加して、仲間と交流しましょう。</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = groups
          .map(({ groups: group }) => {
            const latestMessage = group.group_messages?.[0];
            const unreadCount = unreadCounts[group.id] || 0;

            return `
                    <div class="px-6 py-4 flex items-start hover:bg-gray-50 transition duration-150 cursor-pointer" onclick="window.location.href='groups.html?id=${
                      group.id
                    }';">
                        <div class="flex-shrink-0 mr-4">
                            <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <p class="text-sm font-medium text-gray-900">${
                                  group.name
                                }</p>
                                ${
                                  unreadCount > 0
                                    ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">${unreadCount} 新着</span>`
                                    : ""
                                }
                            </div>
                            ${
                              latestMessage
                                ? `
                                <p class="text-sm text-gray-600 truncate">
                                    <span class="font-medium">${latestMessage.user.last_name}:</span> ${latestMessage.content}
                                </p>
                            `
                                : '<p class="text-sm text-gray-600">まだメッセージがありません</p>'
                            }
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // イベント読み込み
      async function loadEvents() {
        const { data: events } = await supabase
          .from("events")
          .select(
            `
                    *,
                    event_participants!inner(*)
                `
          )
          .gte("event_date", new Date().toISOString())
          .order("event_date", { ascending: true })
          .limit(5);

        const container = document.getElementById("events-container");

        if (!events || events.length === 0) {
          container.innerHTML = `
                    <div class="px-6 py-8 text-center text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">イベントはありません</h3>
                        <p class="mt-1 text-sm text-gray-500">開催予定のイベントがここに表示されます。</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = events
          .map((event) => {
            const eventDate = new Date(event.event_date);
            const isParticipating = event.event_participants.some(
              (p) => p.user_id === currentUser.id
            );
            const daysUntil = Math.ceil(
              (eventDate - new Date()) / (1000 * 60 * 60 * 24)
            );

            return `
                    <div class="px-6 py-4 flex items-start hover:bg-gray-50 transition duration-150 cursor-pointer" onclick="window.location.href='event-detail.html?event=${
                      event.id
                    }';">
                        <div class="flex-shrink-0 mr-4">
                            <div class="h-12 w-12 rounded bg-purple-100 flex flex-col items-center justify-center">
                                <span class="text-xs font-bold text-purple-600">${
                                  eventDate.getMonth() + 1
                                }月</span>
                                <span class="text-lg font-bold text-purple-600">${eventDate.getDate()}</span>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <p class="text-sm font-medium text-gray-900">${
                                  event.title
                                }</p>
                                ${
                                  daysUntil <= 3
                                    ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">${
                                        daysUntil === 0
                                          ? "今日"
                                          : daysUntil === 1
                                          ? "明日"
                                          : `${daysUntil}日後`
                                      }</span>`
                                    : ""
                                }
                            </div>
                            <p class="text-sm text-gray-600">${
                              event.location
                            }</p>
                            <p class="text-xs text-gray-500 mt-1">${
                              event.start_time
                            } - ${event.end_time}</p>
                            ${
                              isParticipating
                                ? `
                                <div class="mt-2">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">参加予定</span>
                                </div>
                            `
                                : ""
                            }
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      

      // 統計情報読み込み
      async function loadStats() {
        const [followingResult, followersResult, groupsResult] =
          await Promise.all([
            supabase
              .from("follows")
              .select("*", { count: "exact", head: true })
              .eq("follower_id", currentUser.id),
            supabase
              .from("follows")
              .select("*", { count: "exact", head: true })
              .eq("following_id", currentUser.id),
            supabase
              .from("group_members")
              .select("*", { count: "exact", head: true })
              .eq("user_id", currentUser.id),
          ]);

        const statsContainer = document.getElementById("profile-stats");
        statsContainer.innerHTML = `
                <div>
                    <p class="text-xl font-semibold text-gray-900">${
                      followingResult.count || 0
                    }</p>
                    <p class="text-sm text-gray-500">フォロー中</p>
                </div>
                <div class="border-l border-gray-300"></div>
                <div>
                    <p class="text-xl font-semibold text-gray-900">${
                      followersResult.count || 0
                    }</p>
                    <p class="text-sm text-gray-500">フォロワー</p>
                </div>
                <div class="border-l border-gray-300"></div>
                <div>
                    <p class="text-xl font-semibold text-gray-900">${
                      groupsResult.count || 0
                    }</p>
                    <p class="text-sm text-gray-500">グループ</p>
                </div>
            `;
      }

      // おすすめユーザー読み込み
      async function loadRecommendedUsers() {
        const res = await fetch(`/api/recommendations?user_id=${currentUser.id}`);
        let users = [];
        if (res.ok) {
          users = await res.json();
        }
        displayRecommendedUsers(users);
      }

      function displayRecommendedUsers(users) {
        const container = document.getElementById("recommended-users");

        if (users.length === 0) {
          container.innerHTML = `
                    <div class="px-6 py-8 text-center text-gray-500">
                        <p class="text-sm">まだおすすめユーザーがいません</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = users
          .map(
            (user) => `
                <div class="px-6 py-4 flex items-start hover:bg-gray-50 transition duration-150 cursor-pointer" onclick="window.location.href='profile-detail.html?user=${
                  user.id
                }';">
                    <div class="flex-shrink-0 mr-4">
                        <img loading="lazy" class="h-10 w-10 rounded-full object-cover" src="${
                          user.profile_image_url || "/api/placeholder/40/40"
                        }" alt="${user.last_name} ${user.first_name}">
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <p class="text-sm font-medium text-gray-900">${
                              user.last_name
                            } ${user.first_name}</p>
                        </div>
                        <p class="text-xs text-gray-500">${
                          locationNames[user.location] || user.location
                        }・${ageNames[user.age_range] || user.age_range}</p>
                        <div class="mt-1 flex flex-wrap gap-1">
                            ${user.skills
                              .slice(0, 2)
                              .map(
                                (skill) => `
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                    ${skillNames[skill] || skill}
                                </span>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // リアルタイムサブスクリプション設定
      function setupRealtimeSubscriptions() {
        // 通知のリアルタイム監視
        supabase
          .channel("dashboard-notifications")
          .on(
            "postgres_changes",
            {
              event: "INSERT",
              schema: "public",
              table: "notifications",
              filter: `user_id=eq.${currentUser.id}`,
            },
            (payload) => {
              loadNotifications();
              document
                .getElementById("notification-dot")
                .classList.remove("hidden");
            }
          )
          .subscribe();

        // メッセージのリアルタイム監視
        supabase
          .channel("dashboard-messages")
          .on(
            "postgres_changes",
            {
              event: "INSERT",
              schema: "public",
              table: "direct_messages",
              filter: `receiver_id=eq.${currentUser.id}`,
            },
            (payload) => {
              loadMessages();
              const badge = document.getElementById("message-badge");
              badge.classList.remove("hidden");
              badge.textContent = parseInt(badge.textContent || 0) + 1;
            }
          )
          .subscribe();

        // フォローリクエストのリアルタイム監視
        supabase
          .channel("dashboard-requests")
          .on(
            "postgres_changes",
            {
              event: "INSERT",
              schema: "public",
              table: "follow_requests",
              filter: `target_id=eq.${currentUser.id}`,
            },
            (payload) => {
              loadFollowRequestCount();
              const badge = document.getElementById("request-badge");
              badge.classList.remove("hidden");
              badge.textContent = parseInt(badge.textContent || 0) + 1;
            }
          )
          .subscribe();
      }
      // 通知を既読にする
      async function markAsRead(notificationId) {
        await supabase
          .from("notifications")
          .update({ is_read: true })
          .eq("id", notificationId);

        loadNotifications();
      }

      // 時間フォーマット
      function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return "今";
        if (diff < 3600000) return `${Math.floor(diff / 60000)}分前`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}時間前`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)}日前`;

        return date.toLocaleDateString("ja-JP");
      }

      const guideSteps = [
        "プロフィールを作成してあなたのスキルや経験を登録します。",
        "検索機能でパートナーを探し、気になる相手にメッセージを送りましょう。",
        "マッチしたらチャットやグループでやり取りし、ビジネスを始めます。",
      ];
      let guideIndex = 0;

      function showGuideStep(index) {
        document.getElementById("guide-step-text").textContent = guideSteps[index];
        document.getElementById("guide-prev").disabled = index === 0;
        document.getElementById("guide-next").textContent = index === guideSteps.length - 1 ? "完了" : "次へ";
      }

      document.getElementById("guide-next").addEventListener("click", () => {
        if (guideIndex < guideSteps.length - 1) {
          guideIndex++;
          showGuideStep(guideIndex);
        } else {
          closeModal("guide-modal");
          guideIndex = 0;
          showGuideStep(guideIndex);
        }
      });

      document.getElementById("guide-prev").addEventListener("click", () => {
        if (guideIndex > 0) {
          guideIndex--;
          showGuideStep(guideIndex);
        }
      });

      document
        .getElementById("close-guide-modal")
        .addEventListener("click", () => closeModal("guide-modal"));

      // 初期ステップ表示
      showGuideStep(guideIndex);
    </script>
    <script src="i18n.js"></script>
    <script src="js/theme.js"></script>
    <script src="accessibility.js"></script>
  </body>
</html>
