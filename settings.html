<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer" />
    <title>アカウント設定 - スタートアップコネクト</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="env.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans JP", sans-serif;
      }
      .settings-nav-active {
        background-color: #eff6ff;
        color: #2563eb;
        border-left: 3px solid #2563eb;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #2563eb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
      <div class="spinner"></div>
    </div>

    <!-- ナビゲーションバー -->
    <header class="bg-white shadow-md sticky top-0 z-20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <div class="flex-shrink-0 flex items-center">
              <a href="index.html">
                <svg
                  class="h-8 w-8 text-blue-600"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </a>
              <a
                href="dashboard.html"
                class="ml-2 text-xl font-bold text-gray-800"
                >スタートアップコネクト</a
              >
            </div>
            <nav class="hidden md:ml-6 md:flex space-x-4">
              <a
                href="dashboard.html"
                class="text-gray-500 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
                >ホーム</a
              >
              <a
                href="search.html"
                class="text-gray-500 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
                >検索</a
              >
              <a
                href="messages.html"
                class="text-gray-500 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
                >メッセージ</a
              >
              <a
                href="groups.html"
                class="text-gray-500 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
                >グループ</a
              >
              <a
                href="events.html"
                class="text-gray-500 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
                >イベント</a
              >
            </nav>
          </div>
          <div class="hidden md:flex items-center">
            <button
              type="button"
              class="relative p-1 rounded-full text-gray-500 hover:text-blue-600 focus:outline-none"
            >
              <span class="sr-only">通知を見る</span>
              <a href="notifications.html" class="relative inline-flex">
                <svg
                  class="h-6 w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                  ></path>
                </svg>
              </a>
            </button>

            <div class="ml-3 relative">
              <div class="flex items-center">
                <button
                  type="button"
                  class="bg-gray-800 flex text-sm rounded-full focus:outline-none"
                  id="user-menu-button"
                >
                  <span class="sr-only">メニューを開く</span>
                  <img
                    id="user-avatar"
                    class="h-8 w-8 rounded-full object-cover"
                    src="/api/placeholder/32/32"
                    alt="プロフィール"
                  />
                </button>
                <div class="ml-2 hidden md:block">
                  <div id="user-name" class="text-sm font-medium text-gray-800">
                    読み込み中...
                  </div>
                  <div id="user-location" class="text-xs text-gray-500">-</div>
                </div>
              </div>

              <div
                id="user-menu"
                class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-30"
              >
                <a
                  href="profile.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >プロフィール</a
                >
                <a
                  href="settings.html"
                  class="block px-4 py-2 text-sm bg-gray-100 text-blue-600"
                  >設定</a
                >
                <a
                  href="#"
                  id="logout-link"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >ログアウト</a
                >
              </div>
            </div>
          </div>

          <div class="flex md:hidden items-center">
            <button
              type="button"
              class="mobile-menu-button text-gray-500 hover:text-blue-600 focus:outline-none"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- モバイルメニュー -->
      <div class="mobile-menu hidden md:hidden bg-white border-t">
        <a
          href="dashboard.html"
          class="block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >ホーム</a
        >
        <a
          href="search.html"
          class="block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >検索</a
        >
        <a
          href="messages.html"
          class="block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >メッセージ</a
        >
        <a
          href="groups.html"
          class="block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >グループ</a
        >
        <a
          href="events.html"
          class="block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >イベント</a
        >
        <div class="border-t border-gray-200 my-1"></div>
        <a
          href="profile.html"
          class="block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >プロフィール</a
        >
        <a href="settings.html" class="block px-4 py-2 text-blue-600 bg-blue-50"
          >設定</a
        >
        <a
          href="#"
          class="logout-link-mobile block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >ログアウト</a
        >
      </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
      <h1 class="text-2xl font-bold text-gray-900 mb-6">アカウント設定</h1>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- サイドナビゲーション -->
        <div class="md:col-span-1 mb-4 md:mb-0">
          <div class="md:hidden">
            <select
              id="mobile-settings-nav"
              class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 bg-white focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="account" selected>アカウント情報</option>
              <option value="notifications">通知設定</option>
              <option value="privacy">プライバシー</option>
              <option value="security">セキュリティ</option>
            </select>
          </div>

          <nav class="hidden md:block space-y-1">
            <a
              href="#"
              data-tab="account"
              class="settings-nav-active block pl-3 pr-4 py-2 border-l-0 md:border-l-3 text-sm font-medium"
            >
              アカウント情報
            </a>
            <a
              href="#"
              data-tab="notifications"
              class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 block pl-3 pr-4 py-2 border-l-0 md:border-l-3 border-transparent text-sm font-medium"
            >
              通知設定
            </a>
            <a
              href="#"
              data-tab="privacy"
              class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 block pl-3 pr-4 py-2 border-l-0 md:border-l-3 border-transparent text-sm font-medium"
            >
              プライバシー
            </a>
            <a
              href="#"
              data-tab="security"
              class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 block pl-3 pr-4 py-2 border-l-0 md:border-l-3 border-transparent text-sm font-medium"
            >
              セキュリティ
            </a>
          </nav>

          <!-- アカウント削除ボタン -->
          <div class="mt-8 hidden md:block">
            <button
              id="delete-account-btn"
              class="text-red-600 hover:text-red-800 text-sm font-medium"
            >
              アカウントを削除する
            </button>
          </div>
        </div>

        <!-- 設定コンテンツエリア -->
        <div class="md:col-span-3">
          <!-- アカウント情報設定 -->
          <div
            id="account-section"
            class="settings-section bg-white shadow rounded-lg"
          >
            <div class="px-4 py-5 sm:p-6">
              <h2 class="text-lg font-medium text-gray-900">アカウント情報</h2>
              <p class="mt-1 text-sm text-gray-500">
                プロフィールの基本情報や連絡先を管理します。
              </p>

              <form id="account-form" class="mt-6 space-y-6">
                <!-- プロフィール画像 -->
                <div>
                  <label class="block text-sm font-medium text-gray-700"
                    >プロフィール画像</label
                  >
                  <div class="mt-2 flex items-center">
                    <span
                      class="inline-block h-12 w-12 rounded-full overflow-hidden bg-gray-100"
                    >
                      <img
                        id="profile-image-preview"
                        src="/api/placeholder/48/48"
                        alt="プロフィール画像"
                        class="h-full w-full object-cover"
                      />
                    </span>
                    <input
                      type="file"
                      id="profile-image-input"
                      accept="image/*"
                      class="hidden"
                    />
                    <button
                      type="button"
                      id="change-image-btn"
                      class="ml-5 bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                      変更
                    </button>
                    <button
                      type="button"
                      id="remove-image-btn"
                      class="ml-3 bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                      削除
                    </button>
                  </div>
                </div>

                <!-- 名前 -->
                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                  <div class="sm:col-span-3">
                    <label
                      for="last-name"
                      class="block text-sm font-medium text-gray-700"
                      >姓</label
                    >
                    <div class="mt-1">
                      <input
                        type="text"
                        name="last-name"
                        id="last-name"
                        required
                        class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                      />
                    </div>
                  </div>
                  <div class="sm:col-span-3">
                    <label
                      for="first-name"
                      class="block text-sm font-medium text-gray-700"
                      >名</label
                    >
                    <div class="mt-1">
                      <input
                        type="text"
                        name="first-name"
                        id="first-name"
                        required
                        class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                      />
                    </div>
                  </div>
                </div>

                <!-- メールアドレス -->
                <div>
                  <label
                    for="email"
                    class="block text-sm font-medium text-gray-700"
                    >メールアドレス</label
                  >
                  <div class="mt-1">
                    <input
                      id="email"
                      name="email"
                      type="email"
                      required
                      class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                    />
                  </div>
                </div>

                <!-- 電話番号 -->
                <div>
                  <label
                    for="phone"
                    class="block text-sm font-medium text-gray-700"
                    >電話番号</label
                  >
                  <div class="mt-1">
                    <input
                      id="phone"
                      name="phone"
                      type="tel"
                      class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                    />
                  </div>
                  <p class="mt-2 text-sm text-gray-500">
                    電話番号は他のユーザーには表示されません。二段階認証などセキュリティのために使用されます。
                  </p>
                </div>

                <!-- 所在地 -->
                <div>
                  <label
                    for="location"
                    class="block text-sm font-medium text-gray-700"
                    >所在地</label
                  >
                  <div class="mt-1">
                    <select
                      id="location"
                      name="location"
                      class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                    >
                      <option value="tokyo">東京都</option>
                      <option value="kanagawa">神奈川県</option>
                      <option value="osaka">大阪府</option>
                      <option value="aichi">愛知県</option>
                      <option value="other">その他</option>
                    </select>
                  </div>
                </div>

                <!-- タイムゾーン -->
                <div>
                  <label
                    for="timezone"
                    class="block text-sm font-medium text-gray-700"
                    >タイムゾーン</label
                  >
                  <div class="mt-1">
                    <select
                      id="timezone"
                      name="timezone"
                      class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                    >
                      <option value="Asia/Tokyo">アジア/東京 (GMT+9)</option>
                      <option value="America/Los_Angeles">
                        アメリカ/ロサンゼルス (GMT-7)
                      </option>
                      <option value="America/New_York">
                        アメリカ/ニューヨーク (GMT-4)
                      </option>
                      <option value="Europe/London">
                        ヨーロッパ/ロンドン (GMT+1)
                      </option>
                    </select>
                  </div>
                </div>

                <div class="pt-5">
                  <div class="flex justify-end">
                    <button
                      type="button"
                      class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                      キャンセル
                    </button>
                    <button
                      type="submit"
                      class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                      保存する
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- 通知設定 -->
          <div
            id="notifications-section"
            class="settings-section hidden bg-white shadow rounded-lg"
          >
            <div class="px-4 py-5 sm:p-6">
              <h2 class="text-lg font-medium text-gray-900">通知設定</h2>
              <p class="mt-1 text-sm text-gray-500">
                メールやプッシュ通知の設定を管理します。
              </p>

              <form id="notifications-form" class="mt-6">
                <!-- メール通知 -->
                <div>
                  <h3 class="text-base font-medium text-gray-900">
                    メール通知
                  </h3>
                  <div class="mt-4 space-y-4">
                    <div class="flex items-start">
                      <div class="flex items-center h-5">
                        <input
                          id="email-direct-messages"
                          name="email_direct_messages"
                          type="checkbox"
                          class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                        />
                      </div>
                      <div class="ml-3 text-sm">
                        <label
                          for="email-direct-messages"
                          class="font-medium text-gray-700"
                          >ダイレクトメッセージ</label
                        >
                        <p class="text-gray-500">
                          新しいメッセージを受信したときにメールで通知します。
                        </p>
                      </div>
                    </div>
                    <div class="flex items-start">
                      <div class="flex items-center h-5">
                        <input
                          id="email-mentions"
                          name="email_mentions"
                          type="checkbox"
                          class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                        />
                      </div>
                      <div class="ml-3 text-sm">
                        <label
                          for="email-mentions"
                          class="font-medium text-gray-700"
                          >メンション</label
                        >
                        <p class="text-gray-500">
                          投稿やコメントであなたがメンションされたときに通知します。
                        </p>
                      </div>
                    </div>
                    <div class="flex items-start">
                      <div class="flex items-center h-5">
                        <input
                          id="email-follow"
                          name="email_follow"
                          type="checkbox"
                          class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                        />
                      </div>
                      <div class="ml-3 text-sm">
                        <label
                          for="email-follow"
                          class="font-medium text-gray-700"
                          >フォロー</label
                        >
                        <p class="text-gray-500">
                          新しいフォロワーがあなたをフォローしたときに通知します。
                        </p>
                      </div>
                    </div>
                    <div class="flex items-start">
                      <div class="flex items-center h-5">
                        <input
                          id="email-events"
                          name="email_events"
                          type="checkbox"
                          class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                        />
                      </div>
                      <div class="ml-3 text-sm">
                        <label
                          for="email-events"
                          class="font-medium text-gray-700"
                          >イベント</label
                        >
                        <p class="text-gray-500">
                          参加予定のイベントに関する更新情報を通知します。
                        </p>
                      </div>
                    </div>
                    <div class="flex items-start">
                      <div class="flex items-center h-5">
                        <input
                          id="email-marketing"
                          name="email_marketing"
                          type="checkbox"
                          class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                        />
                      </div>
                      <div class="ml-3 text-sm">
                        <label
                          for="email-marketing"
                          class="font-medium text-gray-700"
                          >マーケティングメール</label
                        >
                        <p class="text-gray-500">
                          新機能やプロモーションに関する情報を受け取ります。
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- アプリ内通知 -->
                <div class="mt-10">
                  <h3 class="text-base font-medium text-gray-900">
                    アプリ内通知
                  </h3>
                  <div class="mt-4 space-y-4">
                    <div class="flex items-start">
                      <div class="flex items-center h-5">
                        <input
                          id="app-messages"
                          name="app_messages"
                          type="checkbox"
                          class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                        />
                      </div>
                      <div class="ml-3 text-sm">
                        <label
                          for="app-messages"
                          class="font-medium text-gray-700"
                          >メッセージ通知</label
                        >
                        <p class="text-gray-500">
                          アプリ内でメッセージ通知を表示します。
                        </p>
                      </div>
                    </div>
                    <div class="flex items-start">
                      <div class="flex items-center h-5">
                        <input
                          id="app-activity"
                          name="app_activity"
                          type="checkbox"
                          class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                        />
                      </div>
                      <div class="ml-3 text-sm">
                        <label
                          for="app-activity"
                          class="font-medium text-gray-700"
                          >アクティビティ通知</label
                        >
                        <p class="text-gray-500">
                          いいね、コメント、フォローなどのアクティビティを通知します。
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="pt-6">
                  <div class="flex justify-end">
                    <button
                      type="button"
                      class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                      キャンセル
                    </button>
                    <button
                      type="submit"
                      class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                      保存する
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- プライバシー設定 -->
          <div
            id="privacy-section"
            class="settings-section hidden bg-white shadow rounded-lg"
          >
            <div class="px-4 py-5 sm:p-6">
              <h2 class="text-lg font-medium text-gray-900">
                プライバシー設定
              </h2>
              <p class="mt-1 text-sm text-gray-500">
                プロフィールの公開範囲やデータの取り扱いを管理します。
              </p>

              <form id="privacy-form" class="mt-6">
                <!-- プロフィール公開設定 -->
                <div>
                  <h3 class="text-base font-medium text-gray-900">
                    プロフィール公開設定
                  </h3>
                  <div class="mt-4 space-y-4">
                    <div>
                      <label
                        for="profile-visibility"
                        class="block text-sm font-medium text-gray-700"
                        >プロフィール表示</label
                      >
                      <select
                        id="profile-visibility"
                        name="profile_visibility"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                      >
                        <option value="public">すべてのユーザーに公開</option>
                        <option value="connections">
                          つながりのあるユーザーのみ
                        </option>
                        <option value="private">
                          非公開（検索に表示しない）
                        </option>
                      </select>
                    </div>
                    <div>
                      <label
                        for="contact-visibility"
                        class="block text-sm font-medium text-gray-700"
                        >連絡先情報</label
                      >
                      <select
                        id="contact-visibility"
                        name="contact_visibility"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                      >
                        <option value="public">すべてのユーザーに公開</option>
                        <option value="connections">
                          つながりのあるユーザーのみ
                        </option>
                        <option value="private">非公開</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- アクティビティ公開設定 -->
                <div class="mt-10">
                  <h3 class="text-base font-medium text-gray-900">
                    アクティビティ公開設定
                  </h3>
                  <div class="mt-4 space-y-4">
                    <div class="flex items-start">
                      <div class="flex items-center h-5">
                        <input
                          id="activity-projects"
                          name="activity_projects"
                          type="checkbox"
                          class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                        />
                      </div>
                      <div class="ml-3 text-sm">
                        <label
                          for="activity-projects"
                          class="font-medium text-gray-700"
                          >プロジェクト更新の通知</label
                        >
                        <p class="text-gray-500">
                          新しいプロジェクトや更新をネットワークに通知します。
                        </p>
                      </div>
                    </div>
                    <div class="flex items-start">
                      <div class="flex items-center h-5">
                        <input
                          id="activity-groups"
                          name="activity_groups"
                          type="checkbox"
                          class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                        />
                      </div>
                      <div class="ml-3 text-sm">
                        <label
                          for="activity-groups"
                          class="font-medium text-gray-700"
                          >グループ参加の通知</label
                        >
                        <p class="text-gray-500">
                          新しいグループへの参加をネットワークに通知します。
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ブロックリスト -->
                <div class="mt-10">
                  <h3 class="text-base font-medium text-gray-900">
                    ブロックリスト
                  </h3>
                  <p class="mt-1 text-sm text-gray-500">
                    ブロックしたユーザーはあなたのプロフィールを見ることができず、メッセージを送信できなくなります。
                  </p>

                  <div
                    id="blocked-users-list"
                    class="mt-4 border-t border-gray-200 pt-4"
                  >
                    <!-- ブロックリストはJavaScriptで動的に生成 -->
                  </div>

                  <div class="mt-4">
                    <button
                      type="button"
                      id="block-user-btn"
                      class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                      <svg
                        class="mr-2 -ml-1 h-5 w-5 text-gray-400"
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                          clip-rule="evenodd"
                        />
                      </svg>
                      ユーザーをブロック
                    </button>
                  </div>
                </div>

                <div class="pt-6">
                  <div class="flex justify-end">
                    <button
                      type="button"
                      class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                      キャンセル
                    </button>
                    <button
                      type="submit"
                      class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                      保存する
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- セキュリティ設定 -->
          <div
            id="security-section"
            class="settings-section hidden bg-white shadow rounded-lg"
          >
            <div class="px-4 py-5 sm:p-6">
              <h2 class="text-lg font-medium text-gray-900">
                セキュリティ設定
              </h2>
              <p class="mt-1 text-sm text-gray-500">
                パスワードと二段階認証の設定を管理します。
              </p>

              <!-- パスワード変更 -->
              <form id="password-form" class="mt-6">
                <div>
                  <h3 class="text-base font-medium text-gray-900">
                    パスワード変更
                  </h3>
                  <div class="mt-4 space-y-4">
                    <div>
                      <label
                        for="current-password"
                        class="block text-sm font-medium text-gray-700"
                        >現在のパスワード</label
                      >
                      <input
                        type="password"
                        name="current-password"
                        id="current-password"
                        class="mt-1 shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                      />
                    </div>
                    <div>
                      <label
                        for="new-password"
                        class="block text-sm font-medium text-gray-700"
                        >新しいパスワード</label
                      >
                      <input
                        type="password"
                        name="new-password"
                        id="new-password"
                        class="mt-1 shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                      />
                    </div>
                    <div>
                      <label
                        for="confirm-password"
                        class="block text-sm font-medium text-gray-700"
                        >パスワードの確認</label
                      >
                      <input
                        type="password"
                        name="confirm-password"
                        id="confirm-password"
                        class="mt-1 shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                      />
                    </div>
                  </div>

                  <div class="mt-4">
                    <button
                      type="submit"
                      class="bg-blue-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                      パスワードを変更
                    </button>
                  </div>
                </div>
              </form>

              <!-- 二段階認証 -->
              <div class="mt-10">
                <h3 class="text-base font-medium text-gray-900">二段階認証</h3>
                <p class="mt-1 text-sm text-gray-500">
                  アカウントのセキュリティをさらに強化するために二段階認証を設定できます。
                </p>

                <div class="mt-4 flex items-center">
                  <div class="h-6 flex items-center">
                    <input
                      id="two-factor-auth"
                      name="two_factor_enabled"
                      type="checkbox"
                      class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                    />
                  </div>
                  <div class="ml-3">
                    <label
                      for="two-factor-auth"
                      class="font-medium text-gray-700"
                      >二段階認証を有効にする</label
                    >
                  </div>
                </div>

                <div
                  class="mt-6 p-4 bg-gray-50 rounded-md border border-gray-200"
                >
                  <p class="text-sm text-gray-700">
                    二段階認証を有効にすると、ログイン時に追加の認証コードが必要になります。このコードはあなたのモバイルデバイスに送信されます。
                  </p>
                </div>
              </div>

              <!-- セッション管理 -->
              <div class="mt-10">
                <h3 class="text-base font-medium text-gray-900">
                  アクティブなセッション
                </h3>
                <p class="mt-1 text-sm text-gray-500">
                  現在ログインしているデバイスとセッションを管理します。
                </p>

                <div
                  id="active-sessions"
                  class="mt-4 border-t border-b border-gray-200 divide-y divide-gray-200"
                >
                  <!-- セッション情報はJavaScriptで動的に生成 -->
                </div>

                <div class="mt-4">
                  <button
                    type="button"
                    id="revoke-all-sessions"
                    class="text-sm text-red-600 hover:text-red-900"
                  >
                    すべてのセッションを終了する
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- モバイル用アカウント削除ボタン -->
          <div class="mt-10 md:hidden">
            <button
              id="delete-account-mobile-btn"
              class="text-red-600 hover:text-red-800 text-sm font-medium"
            >
              アカウントを削除する
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- フッター -->
    <footer class="bg-gray-100 py-6 mt-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center text-gray-500 text-sm">
          <p>&copy; 2024 スタートアップコネクト. All rights reserved.</p>
          <div class="mt-2 space-x-4">
            <a href="#" class="text-gray-500 hover:text-gray-700">利用規約</a>
            <a href="#" class="text-gray-500 hover:text-gray-700"
              >プライバシーポリシー</a
            >
            <a href="#" class="text-gray-500 hover:text-gray-700"
              >お問い合わせ</a
            >
          </div>
        </div>
      </div>
    </footer>

    <!-- モーダル -->
    <!-- ブロックユーザー追加モーダル -->
    <div
      id="block-user-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50"
    >
      <div
        class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
      >
        <div class="mt-3">
          <h3 class="text-lg font-medium text-gray-900 text-center">
            ユーザーをブロック
          </h3>
          <div class="mt-2 px-7 py-3">
            <input
              type="text"
              id="block-user-search"
              placeholder="ユーザー名またはメールアドレスを入力"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
            <div id="user-search-results" class="mt-4 max-h-60 overflow-y-auto">
              <!-- 検索結果はJavaScriptで動的に生成 -->
            </div>
          </div>
          <div class="items-center px-4 py-3">
            <button
              id="close-block-modal"
              class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-24 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300"
            >
              キャンセル
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 確認モーダル -->
    <div
      id="confirm-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50"
    >
      <div
        class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
      >
        <div class="mt-3 text-center">
          <h3 id="confirm-title" class="text-lg font-medium text-gray-900"></h3>
          <div class="mt-2 px-7 py-3">
            <p id="confirm-message" class="text-sm text-gray-500"></p>
          </div>
          <div class="items-center px-4 py-3 flex justify-center gap-3">
            <button
              id="confirm-cancel"
              class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300"
            >
              キャンセル
            </button>
            <button
              id="confirm-ok"
              class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300"
            >
              実行
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Supabase設定
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__ENV__;
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // グローバル変数
      let currentUser = null;
      let userProfile = null;
      let currentTab = "account";

      // 地域名マッピング
      const locationNames = {
        hokkaido: "北海道",
        aomori: "青森県",
        iwate: "岩手県",
        miyagi: "宮城県",
        akita: "秋田県",
        yamagata: "山形県",
        fukushima: "福島県",
        ibaraki: "茨城県",
        tochigi: "栃木県",
        gunma: "群馬県",
        saitama: "埼玉県",
        chiba: "千葉県",
        tokyo: "東京都",
        kanagawa: "神奈川県",
        niigata: "新潟県",
        toyama: "富山県",
        ishikawa: "石川県",
        fukui: "福井県",
        yamanashi: "山梨県",
        nagano: "長野県",
        gifu: "岐阜県",
        shizuoka: "静岡県",
        aichi: "愛知県",
        mie: "三重県",
        shiga: "滋賀県",
        kyoto: "京都府",
        osaka: "大阪府",
        hyogo: "兵庫県",
        nara: "奈良県",
        wakayama: "和歌山県",
        tottori: "鳥取県",
        shimane: "島根県",
        okayama: "岡山県",
        hiroshima: "広島県",
        yamaguchi: "山口県",
        tokushima: "徳島県",
        kagawa: "香川県",
        ehime: "愛媛県",
        kochi: "高知県",
        fukuoka: "福岡県",
        saga: "佐賀県",
        nagasaki: "長崎県",
        kumamoto: "熊本県",
        oita: "大分県",
        miyazaki: "宮崎県",
        kagoshima: "鹿児島県",
        okinawa: "沖縄県",
      };

      // 初期化
      window.addEventListener("load", async () => {
        await checkAuth();
        await loadUserData();
        await loadSettings();
        setupEventListeners();
        hideLoading();
      });

      // ローディング表示/非表示
      function showLoading() {
        document.getElementById("loading-overlay").classList.remove("hidden");
      }

      function hideLoading() {
        document.getElementById("loading-overlay").classList.add("hidden");
      }

      // 認証チェック
      async function checkAuth() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = "login.html";
          return;
        }
        currentUser = user;
      }

      // ユーザーデータ読み込み
      async function loadUserData() {
        const { data: profile } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", currentUser.id)
          .single();

        if (profile) {
          userProfile = profile;
          updateNavigation(profile);
          populateAccountForm(profile);
        }
      }

      // ナビゲーション更新
      function updateNavigation(profile) {
        document.getElementById(
          "user-name"
        ).textContent = `${profile.last_name} ${profile.first_name}`;
        document.getElementById("user-location").textContent =
          locationNames[profile.location] || profile.location;
        if (profile.profile_image_url) {
          document.getElementById("user-avatar").src =
            profile.profile_image_url;
        }
      }

      // アカウント情報フォーム入力
      function populateAccountForm(profile) {
        document.getElementById("last-name").value = profile.last_name || "";
        document.getElementById("first-name").value = profile.first_name || "";
        document.getElementById("email").value = currentUser.email || "";
        document.getElementById("phone").value = profile.phone || "";
        document.getElementById("location").value = profile.location || "tokyo";
        document.getElementById("timezone").value =
          profile.timezone || "Asia/Tokyo";

        if (profile.profile_image_url) {
          document.getElementById("profile-image-preview").src =
            profile.profile_image_url;
        }
      }

      // 設定データ読み込み
      async function loadSettings() {
        await Promise.all([
          loadNotificationSettings(),
          loadPrivacySettings(),
          loadSecuritySettings(),
          loadBlockedUsers(),
          loadActiveSessions(),
        ]);
      }

      // 通知設定読み込み
      async function loadNotificationSettings() {
        const { data: settings } = await supabase
          .from("notification_settings")
          .select("*")
          .eq("user_id", currentUser.id)
          .single();

        if (settings) {
          document.getElementById("email-direct-messages").checked =
            settings.email_direct_messages;
          document.getElementById("email-mentions").checked =
            settings.email_mentions;
          document.getElementById("email-follow").checked =
            settings.email_follow;
          document.getElementById("email-events").checked =
            settings.email_events;
          document.getElementById("email-marketing").checked =
            settings.email_marketing;
          document.getElementById("app-messages").checked =
            settings.app_messages;
          document.getElementById("app-activity").checked =
            settings.app_activity;
        }
      }

      // プライバシー設定読み込み
      async function loadPrivacySettings() {
        const { data: settings } = await supabase
          .from("privacy_settings")
          .select("*")
          .eq("user_id", currentUser.id)
          .single();

        if (settings) {
          document.getElementById("profile-visibility").value =
            settings.profile_visibility;
          document.getElementById("contact-visibility").value =
            settings.contact_visibility;
          document.getElementById("activity-projects").checked =
            settings.activity_projects;
          document.getElementById("activity-groups").checked =
            settings.activity_groups;
        }
      }

      // セキュリティ設定読み込み
      async function loadSecuritySettings() {
        const { data: settings } = await supabase
          .from("security_settings")
          .select("*")
          .eq("user_id", currentUser.id)
          .single();

        if (settings) {
          document.getElementById("two-factor-auth").checked =
            settings.two_factor_enabled;
        }
      }

      // ブロック済みユーザー読み込み
      async function loadBlockedUsers() {
        const { data: blockedUsers } = await supabase
          .from("blocked_users")
          .select(
            `
                    *,
                    blocked_user:profiles!blocked_users_blocked_id_fkey(*)
                `
          )
          .eq("blocker_id", currentUser.id);

        const container = document.getElementById("blocked-users-list");

        if (!blockedUsers || blockedUsers.length === 0) {
          container.innerHTML =
            '<p class="text-sm text-gray-500 italic">現在ブロックしているユーザーはいません。</p>';
          return;
        }

        container.innerHTML = blockedUsers
          .map(
            (item) => `
                <div class="flex items-center justify-between py-3">
                    <div class="flex items-center">
                        <img class="h-8 w-8 rounded-full object-cover" src="${
                          item.blocked_user.profile_image_url ||
                          "/api/placeholder/32/32"
                        }" alt="${item.blocked_user.last_name} ${
              item.blocked_user.first_name
            }">
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900">${
                              item.blocked_user.last_name
                            } ${item.blocked_user.first_name}</p>
                            <p class="text-xs text-gray-500">${
                              locationNames[item.blocked_user.location] ||
                              item.blocked_user.location
                            }</p>
                        </div>
                    </div>
                    <button onclick="unblockUser('${
                      item.blocked_id
                    }')" class="text-sm text-red-600 hover:text-red-900">ブロック解除</button>
                </div>
            `
          )
          .join("");
      }

      // アクティブセッション読み込み
      async function loadActiveSessions() {
        // 簡単なセッション情報の表示（実際のアプリでは更に詳細な実装が必要）
        const container = document.getElementById("active-sessions");
        container.innerHTML = `
                <div class="py-4 flex justify-between">
                    <div class="flex items-center">
                        <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">現在のブラウザセッション</div>
                            <div class="text-xs text-gray-500">現在アクティブ</div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            現在のセッション
                        </span>
                    </div>
                </div>
            `;
      }

      // イベントリスナー設定
      function setupEventListeners() {
        // ナビゲーション
        setupNavigation();

        // フォーム送信
        setupFormSubmissions();

        // ボタンイベント
        setupButtonEvents();

        // モーダル
        setupModals();
      }

      // ナビゲーション設定
      function setupNavigation() {
        // デスクトップタブ
        document.querySelectorAll("[data-tab]").forEach((tab) => {
          tab.addEventListener("click", (e) => {
            e.preventDefault();
            switchTab(tab.dataset.tab);
          });
        });

        // モバイルセレクト
        document
          .getElementById("mobile-settings-nav")
          .addEventListener("change", (e) => {
            switchTab(e.target.value);
          });

        // ユーザーメニュー
        document
          .getElementById("user-menu-button")
          .addEventListener("click", () => {
            document.getElementById("user-menu").classList.toggle("hidden");
          });

        // モバイルメニュー
        document
          .querySelector(".mobile-menu-button")
          .addEventListener("click", () => {
            document.querySelector(".mobile-menu").classList.toggle("hidden");
          });

        // ウィンドウクリックでメニューを閉じる
        window.addEventListener("click", (e) => {
          if (!document.getElementById("user-menu-button").contains(e.target)) {
            document.getElementById("user-menu").classList.add("hidden");
          }
        });

        // ログアウト
        document
          .getElementById("logout-link")
          .addEventListener("click", logout);
        document
          .querySelector(".logout-link-mobile")
          .addEventListener("click", logout);
      }

      // タブ切り替え
      function switchTab(tabName) {
        // すべてのセクションを非表示
        document.querySelectorAll(".settings-section").forEach((section) => {
          section.classList.add("hidden");
        });

        // 選択されたセクションを表示
        document
          .getElementById(`${tabName}-section`)
          .classList.remove("hidden");

        // ナビゲーションのアクティブ状態更新
        document.querySelectorAll("[data-tab]").forEach((tab) => {
          tab.classList.remove("settings-nav-active");
          tab.classList.add(
            "text-gray-600",
            "hover:bg-gray-50",
            "hover:text-gray-900",
            "border-transparent"
          );
        });

        const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeTab) {
          activeTab.classList.add("settings-nav-active");
          activeTab.classList.remove(
            "text-gray-600",
            "hover:bg-gray-50",
            "hover:text-gray-900",
            "border-transparent"
          );
        }

        // モバイルセレクト更新
        document.getElementById("mobile-settings-nav").value = tabName;
        currentTab = tabName;
      }

      // フォーム送信設定
      function setupFormSubmissions() {
        // アカウント情報フォーム
        document
          .getElementById("account-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            await saveAccountSettings();
          });

        // 通知設定フォーム
        document
          .getElementById("notifications-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            await saveNotificationSettings();
          });

        // プライバシー設定フォーム
        document
          .getElementById("privacy-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            await savePrivacySettings();
          });

        // パスワード変更フォーム
        document
          .getElementById("password-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            await changePassword();
          });
      }

      // ボタンイベント設定
      function setupButtonEvents() {
        // プロフィール画像変更
        document
          .getElementById("change-image-btn")
          .addEventListener("click", () => {
            document.getElementById("profile-image-input").click();
          });

        document
          .getElementById("profile-image-input")
          .addEventListener("change", handleImageUpload);

        // プロフィール画像削除
        document
          .getElementById("remove-image-btn")
          .addEventListener("click", removeProfileImage);

        // ブロックユーザー追加
        document
          .getElementById("block-user-btn")
          .addEventListener("click", () => {
            document
              .getElementById("block-user-modal")
              .classList.remove("hidden");
          });

        // アカウント削除
        document
          .getElementById("delete-account-btn")
          .addEventListener("click", deleteAccount);
        document
          .getElementById("delete-account-mobile-btn")
          .addEventListener("click", deleteAccount);

        // 全セッション終了
        document
          .getElementById("revoke-all-sessions")
          .addEventListener("click", revokeAllSessions);

        // 二段階認証変更
        document
          .getElementById("two-factor-auth")
          .addEventListener("change", toggleTwoFactor);
      }

      // モーダル設定
      function setupModals() {
        // ブロックユーザーモーダル
        document
          .getElementById("close-block-modal")
          .addEventListener("click", () => {
            document.getElementById("block-user-modal").classList.add("hidden");
          });

        // ブロックユーザー検索
        let searchTimeout;
        document
          .getElementById("block-user-search")
          .addEventListener("input", (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(
              () => searchUsersToBlock(e.target.value),
              300
            );
          });

        // 確認モーダル
        document
          .getElementById("confirm-cancel")
          .addEventListener("click", () => {
            document.getElementById("confirm-modal").classList.add("hidden");
          });
      }

      // アカウント設定保存
      async function saveAccountSettings() {
        showLoading();
        try {
          const formData = new FormData(
            document.getElementById("account-form")
          );

          // プロフィール更新
          const { error: profileError } = await supabase
            .from("profiles")
            .update({
              last_name: formData.get("last-name"),
              first_name: formData.get("first-name"),
              phone: formData.get("phone"),
              location: formData.get("location"),
              timezone: formData.get("timezone"),
            })
            .eq("id", currentUser.id);

          if (profileError) throw profileError;

          // メールアドレス変更（Supabase Auth）
          const newEmail = formData.get("email");
          if (newEmail !== currentUser.email) {
            const { error: emailError } = await supabase.auth.updateUser({
              email: newEmail,
            });
            if (emailError) throw emailError;
          }

          showSuccess("アカウント情報を更新しました。");
          await loadUserData();
        } catch (error) {
          showError("アカウント情報の更新に失敗しました: " + error.message);
        } finally {
          hideLoading();
        }
      }

      // 通知設定保存
      async function saveNotificationSettings() {
        showLoading();
        try {
          const formData = new FormData(
            document.getElementById("notifications-form")
          );

          const { error } = await supabase.from("notification_settings").upsert(
            {
              user_id: currentUser.id,
              email_direct_messages: formData.has("email_direct_messages"),
              email_mentions: formData.has("email_mentions"),
              email_follow: formData.has("email_follow"),
              email_events: formData.has("email_events"),
              email_marketing: formData.has("email_marketing"),
              app_messages: formData.has("app_messages"),
              app_activity: formData.has("app_activity"),
            },
            {
              onConflict: "user_id",
            }
          );

          if (error) throw error;

          showSuccess("通知設定を更新しました。");
        } catch (error) {
          showError("通知設定の更新に失敗しました: " + error.message);
        } finally {
          hideLoading();
        }
      }

      // プライバシー設定保存
      async function savePrivacySettings() {
        showLoading();
        try {
          const formData = new FormData(
            document.getElementById("privacy-form")
          );

          const { error } = await supabase.from("privacy_settings").upsert(
            {
              user_id: currentUser.id,
              profile_visibility: formData.get("profile_visibility"),
              contact_visibility: formData.get("contact_visibility"),
              activity_projects: formData.has("activity_projects"),
              activity_groups: formData.has("activity_groups"),
            },
            {
              onConflict: "user_id",
            }
          );

          if (error) throw error;

          showSuccess("プライバシー設定を更新しました。");
        } catch (error) {
          showError("プライバシー設定の更新に失敗しました: " + error.message);
        } finally {
          hideLoading();
        }
      }

      // パスワード変更
      async function changePassword() {
        const currentPassword =
          document.getElementById("current-password").value;
        const newPassword = document.getElementById("new-password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;

        if (newPassword !== confirmPassword) {
          showError("新しいパスワードと確認用パスワードが一致しません。");
          return;
        }

        if (newPassword.length < 6) {
          showError("パスワードは6文字以上で入力してください。");
          return;
        }

        showLoading();
        try {
          const { error } = await supabase.auth.updateUser({
            password: newPassword,
          });

          if (error) throw error;

          // パスワード変更日時を記録
          await supabase.from("security_settings").upsert(
            {
              user_id: currentUser.id,
              last_password_change: new Date().toISOString(),
            },
            {
              onConflict: "user_id",
            }
          );

          showSuccess("パスワードを変更しました。");
          document.getElementById("password-form").reset();
        } catch (error) {
          showError("パスワードの変更に失敗しました: " + error.message);
        } finally {
          hideLoading();
        }
      }

      // プロフィール画像アップロード
      async function handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        showLoading();
        try {
          // ファイルサイズチェック（5MB以下）
          if (file.size > 5 * 1024 * 1024) {
            throw new Error("ファイルサイズは5MB以下にしてください。");
          }

          // ファイル形式チェック
          const allowedTypes = [
            "image/jpeg",
            "image/jpg",
            "image/png",
            "image/gif",
            "image/webp",
          ];
          if (!allowedTypes.includes(file.type)) {
            throw new Error(
              "JPEG、PNG、GIF、WebPファイルのみアップロード可能です。"
            );
          }

          // ファイル名生成（フォルダ構造なしの単純な形式）
          const fileExt = file.name.split(".").pop().toLowerCase();
          const fileName = `profile_${currentUser.id}_${Date.now()}.${fileExt}`;

          // 既存の画像があれば削除
          if (userProfile?.profile_image_url) {
            try {
              const oldFileName = userProfile.profile_image_url
                .split("/")
                .pop();
              await supabase.storage
                .from("profile-images")
                .remove([oldFileName]);
            } catch (deleteError) {
              console.warn("Old image deletion failed:", deleteError);
            }
          }

          // Supabase Storageにアップロード
          const { data, error: uploadError } = await supabase.storage
            .from("profile-images")
            .upload(fileName, file, {
              cacheControl: "3600",
              upsert: true,
            });

          if (uploadError) throw uploadError;

          // パブリックURLを取得
          const {
            data: { publicUrl },
          } = supabase.storage.from("profile-images").getPublicUrl(fileName);

          // プロフィールを更新
          const { error: updateError } = await supabase
            .from("profiles")
            .update({ profile_image_url: publicUrl })
            .eq("id", currentUser.id);

          if (updateError) throw updateError;

          // プレビューを更新
          document.getElementById("profile-image-preview").src = publicUrl;
          document.getElementById("user-avatar").src = publicUrl;

          // グローバル変数も更新
          if (userProfile) {
            userProfile.profile_image_url = publicUrl;
          }

          showSuccess("プロフィール画像を更新しました。");
        } catch (error) {
          console.error("Image upload error:", error);
          showError(
            "プロフィール画像のアップロードに失敗しました: " + error.message
          );
        } finally {
          hideLoading();
        }
      }

      // プロフィール画像削除
      async function removeProfileImage() {
        const confirmed = await showConfirm(
          "プロフィール画像の削除",
          "プロフィール画像を削除しますか？この操作は取り消せません。"
        );

        if (!confirmed) return;

        showLoading();
        try {
          const { error } = await supabase
            .from("profiles")
            .update({ profile_image_url: null })
            .eq("id", currentUser.id);

          if (error) throw error;

          document.getElementById("profile-image-preview").src =
            "/api/placeholder/48/48";
          document.getElementById("user-avatar").src = "/api/placeholder/32/32";

          showSuccess("プロフィール画像を削除しました。");
        } catch (error) {
          showError("プロフィール画像の削除に失敗しました: " + error.message);
        } finally {
          hideLoading();
        }
      }

      // ブロックするユーザー検索
      async function searchUsersToBlock(query) {
        if (!query.trim()) {
          document.getElementById("user-search-results").innerHTML = "";
          return;
        }

        try {
          const { data: users } = await supabase
            .from("profiles")
            .select("*")
            .neq("id", currentUser.id)
            .or(`last_name.ilike.%${query}%,first_name.ilike.%${query}%`)
            .limit(5);

          const container = document.getElementById("user-search-results");

          if (!users || users.length === 0) {
            container.innerHTML =
              '<p class="text-sm text-gray-500 text-center py-2">ユーザーが見つかりませんでした。</p>';
            return;
          }

          container.innerHTML = users
            .map(
              (user) => `
                    <div class="flex items-center justify-between py-2 px-2 hover:bg-gray-50 rounded">
                        <div class="flex items-center">
                            <img class="h-8 w-8 rounded-full object-cover" src="${
                              user.profile_image_url || "/api/placeholder/32/32"
                            }" alt="${user.last_name} ${user.first_name}">
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">${
                                  user.last_name
                                } ${user.first_name}</p>
                                <p class="text-xs text-gray-500">${
                                  locationNames[user.location] || user.location
                                }</p>
                            </div>
                        </div>
                        <button onclick="blockUser('${
                          user.id
                        }')" class="text-sm text-red-600 hover:text-red-900 px-2 py-1 rounded hover:bg-red-50">
                            ブロック
                        </button>
                    </div>
                `
            )
            .join("");
        } catch (error) {
          console.error("User search error:", error);
        }
      }

      // ユーザーをブロック
      async function blockUser(userId) {
        showLoading();
        try {
          const { error } = await supabase.from("blocked_users").insert({
            blocker_id: currentUser.id,
            blocked_id: userId,
          });

          if (error) throw error;

          document.getElementById("block-user-modal").classList.add("hidden");
          await loadBlockedUsers();
          showSuccess("ユーザーをブロックしました。");
        } catch (error) {
          showError("ユーザーのブロックに失敗しました: " + error.message);
        } finally {
          hideLoading();
        }
      }

      // ユーザーのブロック解除
      async function unblockUser(userId) {
        const confirmed = await showConfirm(
          "ブロック解除",
          "このユーザーのブロックを解除しますか？"
        );

        if (!confirmed) return;

        showLoading();
        try {
          const { error } = await supabase
            .from("blocked_users")
            .delete()
            .eq("blocker_id", currentUser.id)
            .eq("blocked_id", userId);

          if (error) throw error;

          await loadBlockedUsers();
          showSuccess("ブロックを解除しました。");
        } catch (error) {
          showError("ブロック解除に失敗しました: " + error.message);
        } finally {
          hideLoading();
        }
      }

      // 二段階認証切り替え
      async function toggleTwoFactor(e) {
        const enabled = e.target.checked;

        showLoading();
        try {
          const { error } = await supabase.from("security_settings").upsert(
            {
              user_id: currentUser.id,
              two_factor_enabled: enabled,
            },
            {
              onConflict: "user_id",
            }
          );

          if (error) throw error;

          showSuccess(
            enabled
              ? "二段階認証を有効にしました。"
              : "二段階認証を無効にしました。"
          );
        } catch (error) {
          showError("二段階認証の設定に失敗しました: " + error.message);
          e.target.checked = !enabled; // 元に戻す
        } finally {
          hideLoading();
        }
      }

      // 全セッション終了
      async function revokeAllSessions() {
        const confirmed = await showConfirm(
          "セッション終了",
          "すべてのセッションを終了しますか？他のデバイスからログアウトされ、再度ログインが必要になります。"
        );

        if (!confirmed) return;

        showLoading();
        try {
          // Supabaseの場合、現在のセッション以外を終了する機能は限定的
          // 実際のアプリでは、カスタムのセッション管理が必要
          await supabase.auth.refreshSession();
          showSuccess("セッションを更新しました。");
        } catch (error) {
          showError("セッションの操作に失敗しました: " + error.message);
        } finally {
          hideLoading();
        }
      }

      // アカウント削除
      async function deleteAccount() {
        const confirmed = await showConfirm(
          "アカウント削除",
          "アカウントを削除しますか？この操作は取り消せません。すべてのデータが完全に削除されます。",
          "削除する"
        );

        if (!confirmed) return;

        showLoading();
        try {
          // 関連データを削除（カスケード削除が設定されている場合は自動的に削除される）
          const { error } = await supabase.auth.admin.deleteUser(
            currentUser.id
          );

          if (error) throw error;

          alert("アカウントが削除されました。ご利用ありがとうございました。");
          window.location.href = "index.html";
        } catch (error) {
          showError("アカウントの削除に失敗しました: " + error.message);
        } finally {
          hideLoading();
        }
      }

      // ログアウト
      async function logout(e) {
        e.preventDefault();
        await supabase.auth.signOut();
        window.location.href = "login.html?message=logout";
      }

      // 確認モーダル表示
      function showConfirm(title, message, okText = "実行") {
        return new Promise((resolve) => {
          document.getElementById("confirm-title").textContent = title;
          document.getElementById("confirm-message").textContent = message;
          document.getElementById("confirm-ok").textContent = okText;
          document.getElementById("confirm-modal").classList.remove("hidden");

          const handleOk = () => {
            document.getElementById("confirm-modal").classList.add("hidden");
            document
              .getElementById("confirm-ok")
              .removeEventListener("click", handleOk);
            document
              .getElementById("confirm-cancel")
              .removeEventListener("click", handleCancel);
            resolve(true);
          };

          const handleCancel = () => {
            document.getElementById("confirm-modal").classList.add("hidden");
            document
              .getElementById("confirm-ok")
              .removeEventListener("click", handleOk);
            document
              .getElementById("confirm-cancel")
              .removeEventListener("click", handleCancel);
            resolve(false);
          };

          document
            .getElementById("confirm-ok")
            .addEventListener("click", handleOk);
          document
            .getElementById("confirm-cancel")
            .addEventListener("click", handleCancel);
        });
      }

      // 成功メッセージ表示
      function showSuccess(message) {
        // 簡単な実装（通常はトーストライブラリを使用）
        const alert = document.createElement("div");
        alert.className =
          "fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-md shadow-lg z-[9999]";
        alert.textContent = message;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
      }

      // エラーメッセージ表示
      function showError(message) {
        const alert = document.createElement("div");
        alert.className =
          "fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-md shadow-lg z-[9999]";
        alert.textContent = message;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
      }
    </script>
  </body>
</html>
