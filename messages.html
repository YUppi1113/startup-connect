<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer" />
    <title>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ - ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã‚³ãƒã‚¯ãƒˆ</title>
    <link rel="stylesheet" href="styles/styles.css" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans JP", sans-serif;
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 5px;
      }
      .scrollbar-thin::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 5px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }
      .chat-height {
        height: calc(100vh - 200px);
      }
      .messages-height {
        height: calc(100vh - 300px);
      }
    </style>
  </head>
  <body class="bg-gray-50 dark:bg-dark-bg dark:text-dark-text min-h-screen">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <script>
      const hXhr = new XMLHttpRequest();
      hXhr.open("GET", "partials/header.html", false);
      hXhr.send(null);
      document.write(hXhr.responseText);
    </script>


    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h1>
        <div class="flex gap-2">
          <button
            id="new-message-btn"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition duration-200 flex items-center"
          >
            <svg
              class="h-5 w-5 mr-1"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
              />
            </svg>
            æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          </button>
          <a
            href="groups.html"
            class="border border-blue-600 text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition duration-200 flex items-center"
          >
            <svg
              class="h-5 w-5 mr-1"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
              />
            </svg>
            ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆ
          </a>
        </div>
      </div>

      <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="flex flex-col md:flex-row h-full">
          <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
          <div
            class="md:hidden flex justify-between items-center p-4 border-b border-gray-200"
          >
            <button
              id="toggle-contact-list"
              class="text-gray-600 hover:text-blue-600"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                ></path>
              </svg>
            </button>
            <h2 class="text-lg font-medium text-gray-900">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h2>
            <button
              id="toggle-contact-info"
              class="text-gray-600 hover:text-blue-600"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
            </button>
          </div>

          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
          <div
            id="contact-list"
            class="w-full md:w-80 lg:w-96 border-r border-gray-200 flex flex-col"
          >
            <div class="p-4 border-b border-gray-200">
              <div class="relative">
                <input
                  type="text"
                  id="search-users"
                  class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢"
                />
                <div
                  class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                >
                  <svg
                    class="h-5 w-5 text-gray-400"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
              </div>
            </div>

            <div
              id="conversations-list"
              class="overflow-y-auto scrollbar-thin chat-height"
            >
              <!-- ä¼šè©±ä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
              <div id="loading-conversations" class="p-4">
                <div class="space-y-3">
                  <div class="flex items-center space-x-3">
                    <div class="skeleton w-12 h-12 rounded-full"></div>
                    <div class="flex-1">
                      <div class="skeleton h-4 w-3/4 mb-2"></div>
                      <div class="skeleton h-3 w-1/2"></div>
                    </div>
                  </div>
                  <div class="flex items-center space-x-3">
                    <div class="skeleton w-12 h-12 rounded-full"></div>
                    <div class="flex-1">
                      <div class="skeleton h-4 w-3/4 mb-2"></div>
                      <div class="skeleton h-3 w-1/2"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div id="conversations-content" class="hidden">
                <!-- å®Ÿéš›ã®ä¼šè©±ä¸€è¦§ã¯ã“ã“ã«è¡¨ç¤º -->
              </div>
              <div
                id="no-conversations"
                class="hidden p-4 text-center text-gray-500"
              >
                <svg
                  class="mx-auto h-12 w-12 text-gray-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                  />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">
                  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“
                </h3>
                <p class="mt-1 text-sm text-gray-500">
                  æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ä¼šè©±ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚
                </p>
              </div>
            </div>
          </div>

          <!-- ãƒãƒ£ãƒƒãƒˆæœ¬æ–‡ -->
          <div id="chat-content" class="flex-1 flex flex-col">
            <!-- ãƒãƒ£ãƒƒãƒˆæœªé¸æŠçŠ¶æ…‹ -->
            <div
              id="no-chat-selected"
              class="flex-1 flex items-center justify-center text-gray-500"
            >
              <div class="text-center">
                <svg
                  class="mx-auto h-16 w-16 text-gray-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                  />
                </svg>
                <h3 class="mt-4 text-lg font-medium text-gray-900">
                  ä¼šè©±ã‚’é¸æŠã—ã¦ãã ã•ã„
                </h3>
                <p class="mt-2 text-sm text-gray-500">
                  å·¦å´ã®ãƒªã‚¹ãƒˆã‹ã‚‰ä¼šè©±ã‚’é¸æŠã™ã‚‹ã‹ã€æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
                </p>
              </div>
            </div>

            <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ£ãƒƒãƒˆ -->
            <div id="active-chat" class="hidden flex-1 flex flex-col">
              <div
                class="flex items-center justify-between p-4 border-b border-gray-200"
              >
                <div class="flex items-center">
                  <div class="relative">
                    <img loading="lazy"
                      id="chat-user-avatar"
                      class="h-10 w-10 rounded-full object-cover"
                      src="/api/placeholder/40/40"
                      alt=""
                    />
                    <span
                      id="chat-user-status"
                      class="absolute bottom-0 right-0 block h-3 w-3 rounded-full bg-gray-300 border-2 border-white"
                    ></span>
                  </div>
                  <div class="ml-3">
                    <h3 id="chat-user-name" class="font-medium text-gray-900">
                      -
                    </h3>
                    <div id="chat-user-info" class="text-xs text-gray-500">
                      -
                    </div>
                  </div>
                </div>
                <div class="flex">
                  <button
                    type="button"
                    class="p-2 text-gray-500 hover:text-blue-600 rounded-full"
                    id="video-call-btn"
                    title="ãƒ“ãƒ‡ã‚ªé€šè©±"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                      />
                    </svg>
                  </button>
                  <button
                    type="button"
                    class="p-2 text-gray-500 hover:text-blue-600 rounded-full"
                    id="voice-call-btn"
                    title="éŸ³å£°é€šè©±"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                      />
                    </svg>
                  </button>
                  <button
                    type="button"
                    class="p-2 text-gray-500 hover:text-blue-600 rounded-full"
                    title="ãã®ä»–"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                      />
                    </svg>
                  </button>
                  <button
                    id="show-contact-info"
                    type="button"
                    class="p-2 text-gray-500 hover:text-blue-600 rounded-full md:hidden lg:block"
                    title="ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                  </button>
                </div>
              </div>

              <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
              <div
                id="messages-container"
                class="flex-1 overflow-y-auto p-4 scrollbar-thin messages-height"
              >
                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
              </div>

              <!-- ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
              <div id="typing-indicator" class="hidden px-4 py-2">
                <div class="flex items-start">
                  <img loading="lazy"
                    id="typing-user-avatar"
                    class="h-8 w-8 rounded-full object-cover mr-2"
                    src="/api/placeholder/32/32"
                    alt=""
                  />
                  <div class="bg-gray-100 rounded-lg px-3 py-2">
                    <div class="flex space-x-1">
                      <div
                        class="w-2 h-2 rounded-full bg-gray-500 animate-bounce"
                      ></div>
                      <div
                        class="w-2 h-2 rounded-full bg-gray-500 animate-bounce"
                        style="animation-delay: 0.2s"
                      ></div>
                      <div
                        class="w-2 h-2 rounded-full bg-gray-500 animate-bounce"
                        style="animation-delay: 0.4s"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã‚¨ãƒªã‚¢ -->
              <div class="border-t border-gray-200 p-4">
                <div class="flex items-center">
                  <button
                    type="button"
                    id="attach-file-btn"
                    class="p-2 text-gray-500 hover:text-blue-600 rounded-full"
                    title="ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜"
                  >
                    <svg
                      class="h-6 w-6"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"
                      ></path>
                    </svg>
                  </button>
                  <button
                    type="button"
                    id="attach-image-btn"
                    class="p-2 text-gray-500 hover:text-blue-600 rounded-full"
                    title="ç”»åƒæ·»ä»˜"
                  >
                    <svg
                      class="h-6 w-6"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                      ></path>
                    </svg>
                  </button>
                  <div class="flex-1 mx-2">
                    <input
                      type="text"
                      id="message-input"
                      class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                    />
                  </div>
                  <button
                    type="button"
                    id="send-message-btn"
                    class="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-200"
                    title="é€ä¿¡"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 12h14M12 5l7 7-7 7"
                      />
                    </svg>
                  </button>
                  <input
                    type="file"
                    id="file-input"
                    class="hidden"
                    accept="*/*"
                  />
                  <input
                    type="file"
                    id="image-input"
                    class="hidden"
                    accept="image/*"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
          <div
            id="contact-info"
            class="hidden lg:block w-80 border-l border-gray-200"
          >
            <div class="p-4 border-b border-gray-200">
              <h3 class="font-medium text-gray-900">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h3>
            </div>
            <div id="contact-info-content" class="p-4">
              <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="new-message-modal" class="fixed inset-0 z-30 hidden" role="dialog" aria-modal="true">
      <div class="absolute inset-0 bg-gray-900 bg-opacity-50"></div>
      <div
        class="relative max-w-lg mx-auto mt-20 bg-white rounded-lg shadow-xl"
      >
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-semibold text-gray-900">æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
            <button
              id="close-new-message-modal"
              class="text-gray-400 hover:text-gray-500"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >å®›å…ˆ</label
            >
            <div class="relative">
              <input
                type="text"
                id="recipient-search"
                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§æ¤œç´¢"
              />
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <svg
                  class="h-5 w-5 text-gray-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
            </div>
            <div
              id="recipient-suggestions"
              class="mt-2 hidden border border-gray-300 rounded-md max-h-48 overflow-y-auto"
            >
              <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å€™è£œãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
          </div>

          <div class="mb-6">
            <label
              for="initial-message"
              class="block text-sm font-medium text-gray-700 mb-2"
              >ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label
            >
            <textarea
              id="initial-message"
              rows="4"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
            ></textarea>
          </div>

          <div class="flex justify-end space-x-3">
            <button
              type="button"
              id="cancel-new-message"
              class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 font-medium hover:bg-gray-50 transition duration-200"
            >
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button
              type="button"
              id="send-new-message"
              class="px-4 py-2 bg-blue-600 text-white rounded-md font-medium hover:bg-blue-700 transition duration-200"
            >
              é€ä¿¡
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- é€šè©±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="call-modal" class="fixed inset-0 z-30 hidden" role="dialog" aria-modal="true">
      <div class="absolute inset-0 bg-gray-900 bg-opacity-75"></div>
      <div
        class="relative max-w-md mx-auto mt-20 bg-white rounded-lg shadow-xl overflow-hidden"
      >
        <div class="p-6 text-center">
          <div class="mb-6">
            <img loading="lazy"
              id="call-user-avatar"
              src="/api/placeholder/96/96"
              alt=""
              class="h-24 w-24 rounded-full object-cover mx-auto"
            />
            <h3
              id="call-user-name"
              class="text-xl font-semibold text-gray-900 mt-4"
            >
              -
            </h3>
            <p id="call-status" class="text-gray-600 mt-2">ç™ºä¿¡ä¸­...</p>
          </div>
          <div class="flex justify-center space-x-4">
            <button
              id="mute-btn"
              class="p-4 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition duration-200"
              title="ãƒŸãƒ¥ãƒ¼ãƒˆ"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
                />
              </svg>
            </button>
            <button
              id="end-call-btn"
              class="p-4 bg-red-600 text-white rounded-full hover:bg-red-700 transition duration-200"
              title="é€šè©±çµ‚äº†"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z"
                />
              </svg>
            </button>
            <button
              id="speaker-btn"
              class="p-4 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition duration-200"
              title="ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <script>
  const fXhr = new XMLHttpRequest();
  fXhr.open("GET","partials/footer.html",false);
  fXhr.send(null);
  document.write(fXhr.responseText);
</script>

    <script type="module">
      import {
        composeMessage,
        sendMessage as sendMessageAPI,
        updateDirectMessage,
        deleteDirectMessage
      } from './js/message.js';
      // Supabaseè¨­å®š
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__ENV__;
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
      let currentUser = null;
      let userProfile = null;
      let currentChatUser = null;
      let conversations = [];
      let currentMessages = [];
      let selectedRecipient = null;
      let typingTimeout = null;

      // åœ°åŸŸåãƒãƒƒãƒ”ãƒ³ã‚°
      const locationNames = {
        hokkaido: "åŒ—æµ·é“",
        aomori: "é’æ£®çœŒ",
        iwate: "å²©æ‰‹çœŒ",
        miyagi: "å®®åŸçœŒ",
        akita: "ç§‹ç”°çœŒ",
        yamagata: "å±±å½¢çœŒ",
        fukushima: "ç¦å³¶çœŒ",
        ibaraki: "èŒ¨åŸçœŒ",
        tochigi: "æ ƒæœ¨çœŒ",
        gunma: "ç¾¤é¦¬çœŒ",
        saitama: "åŸ¼ç‰çœŒ",
        chiba: "åƒè‘‰çœŒ",
        tokyo: "æ±äº¬éƒ½",
        kanagawa: "ç¥å¥ˆå·çœŒ",
        niigata: "æ–°æ½ŸçœŒ",
        toyama: "å¯Œå±±çœŒ",
        ishikawa: "çŸ³å·çœŒ",
        fukui: "ç¦äº•çœŒ",
        yamanashi: "å±±æ¢¨çœŒ",
        nagano: "é•·é‡çœŒ",
        gifu: "å²é˜œçœŒ",
        shizuoka: "é™å²¡çœŒ",
        aichi: "æ„›çŸ¥çœŒ",
        mie: "ä¸‰é‡çœŒ",
        shiga: "æ»‹è³€çœŒ",
        kyoto: "äº¬éƒ½åºœ",
        osaka: "å¤§é˜ªåºœ",
        hyogo: "å…µåº«çœŒ",
        nara: "å¥ˆè‰¯çœŒ",
        wakayama: "å’Œæ­Œå±±çœŒ",
        tottori: "é³¥å–çœŒ",
        shimane: "å³¶æ ¹çœŒ",
        okayama: "å²¡å±±çœŒ",
        hiroshima: "åºƒå³¶çœŒ",
        yamaguchi: "å±±å£çœŒ",
        tokushima: "å¾³å³¶çœŒ",
        kagawa: "é¦™å·çœŒ",
        ehime: "æ„›åª›çœŒ",
        kochi: "é«˜çŸ¥çœŒ",
        fukuoka: "ç¦å²¡çœŒ",
        saga: "ä½è³€çœŒ",
        nagasaki: "é•·å´çœŒ",
        kumamoto: "ç†Šæœ¬çœŒ",
        oita: "å¤§åˆ†çœŒ",
        miyazaki: "å®®å´çœŒ",
        kagoshima: "é¹¿å…å³¶çœŒ",
        okinawa: "æ²–ç¸„çœŒ",
      };

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
      window.addEventListener("load", async () => {
        await checkAuth();
        await loadConversations();
        setupRealtimeSubscriptions();

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get("user");
        if (userId) {
          await startChatWithUser(userId);
        }
      });

      // èªè¨¼ãƒã‚§ãƒƒã‚¯
      async function checkAuth() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = "login.html";
          return;
        }
        currentUser = user;
        await loadUserProfile();
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
      async function loadUserProfile() {
        const { data: profile } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", currentUser.id)
          .single();

        if (profile) {
          userProfile = profile;
          updateUserInfo(profile);
        }
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°
      function updateUserInfo(profile) {
        document.getElementById(
          "user-name"
        ).textContent = `${profile.last_name} ${profile.first_name}`;
        document.getElementById("user-location").textContent =
          locationNames[profile.location] || profile.location;
        if (profile.profile_image_url) {
          document.getElementById("user-avatar").src =
            profile.profile_image_url;
        }
      }

      // ä¼šè©±ä¸€è¦§èª­ã¿è¾¼ã¿
      async function loadConversations() {
        showLoadingConversations();

        // é€ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const { data: sentMessages } = await supabase
          .from("direct_messages")
          .select(
            `
                    *,
                    receiver:profiles!direct_messages_receiver_id_fkey(*)
                `
          )
          .eq("sender_id", currentUser.id)
          .order("created_at", { ascending: false });

        // å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const { data: receivedMessages } = await supabase
          .from("direct_messages")
          .select(
            `
                    *,
                    sender:profiles!direct_messages_sender_id_fkey(*)
                `
          )
          .eq("receiver_id", currentUser.id)
          .order("created_at", { ascending: false });

        // ä¼šè©±ã‚’æ•´ç†
        const conversationMap = new Map();

        // é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†
        sentMessages?.forEach((message) => {
          const otherId = message.receiver_id;
          if (
            !conversationMap.has(otherId) ||
            new Date(message.created_at) >
              new Date(conversationMap.get(otherId).lastMessage.created_at)
          ) {
            conversationMap.set(otherId, {
              user: message.receiver,
              lastMessage: message,
              unreadCount: 0,
              isSentByMe: true,
            });
          }
        });

        // å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†
        receivedMessages?.forEach((message) => {
          const otherId = message.sender_id;
          const existing = conversationMap.get(otherId);
          if (
            !existing ||
            new Date(message.created_at) >
              new Date(existing.lastMessage.created_at)
          ) {
            const unreadCount = receivedMessages.filter(
              (m) => m.sender_id === otherId && !m.is_read
            ).length;

            conversationMap.set(otherId, {
              user: message.sender,
              lastMessage: message,
              unreadCount: unreadCount,
              isSentByMe: false,
            });
          }
        });

        conversations = Array.from(conversationMap.values()).sort(
          (a, b) =>
            new Date(b.lastMessage.created_at) -
            new Date(a.lastMessage.created_at)
        );

        displayConversations();
      }

      // ä¼šè©±ä¸€è¦§è¡¨ç¤º
      function displayConversations() {
        const container = document.getElementById("conversations-content");
        const loadingElement = document.getElementById("loading-conversations");
        const noConversationsElement =
          document.getElementById("no-conversations");

        loadingElement.classList.add("hidden");

        if (conversations.length === 0) {
          container.classList.add("hidden");
          noConversationsElement.classList.remove("hidden");
          return;
        }

        container.classList.remove("hidden");
        noConversationsElement.classList.add("hidden");

        container.innerHTML = conversations
          .map((conv) => {
            const isActive = currentChatUser?.id === conv.user.id;
            const truncatedMessage =
              conv.lastMessage.content.length > 50
                ? conv.lastMessage.content.substring(0, 50) + "..."
                : conv.lastMessage.content;

            return `
                    <div class="px-4 py-3 ${
                      isActive
                        ? "bg-blue-50 border-l-4 border-blue-600"
                        : "bg-white"
                    } flex items-start hover:bg-gray-50 transition duration-150 cursor-pointer" onclick="selectConversation('${
              conv.user.id
            }')">
                        <div class="relative flex-shrink-0">
                            <img loading="lazy" class="w-12 h-12 rounded-full object-cover" src="${
                              conv.user.profile_image_url ||
                              "/api/placeholder/48/48"
                            }" alt="${conv.user.last_name} ${
              conv.user.first_name
            }">
                            <span class="absolute bottom-0 right-0 block h-3 w-3 rounded-full bg-green-500 border-2 border-white"></span>
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="flex justify-between items-baseline">
                                <h3 class="text-sm font-medium text-gray-900">${
                                  conv.user.last_name
                                } ${conv.user.first_name}</h3>
                                <span class="text-xs text-gray-500">${formatMessageTime(
                                  conv.lastMessage.created_at
                                )}</span>
                            </div>
                            <p class="text-sm text-gray-600 line-clamp-1 ${
                              !conv.isSentByMe && conv.unreadCount > 0
                                ? "font-semibold"
                                : ""
                            }">
                                ${
                                  conv.isSentByMe ? "ã‚ãªãŸ: " : ""
                                }${truncatedMessage}
                            </p>
                            ${
                              conv.unreadCount > 0
                                ? `
                                <div class="mt-1">
                                    <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-blue-600 rounded-full">${conv.unreadCount}</span>
                                </div>
                            `
                                : ""
                            }
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // ä¼šè©±é¸æŠ
      async function selectConversation(userId) {
        await startChatWithUser(userId);
      }

      // ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ãƒãƒ£ãƒƒãƒˆé–‹å§‹
      async function startChatWithUser(userId) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        const { data: user } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", userId)
          .single();

        if (!user) {
          console.error("User not found");
          return;
        }

        currentChatUser = user;

        // ãƒãƒ£ãƒƒãƒˆUIã‚’è¡¨ç¤º
        showChatInterface(user);

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿
        await loadMessages(userId);

        // æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¢èª­ã«ã™ã‚‹
        await markMessagesAsRead(userId);

        // ä¼šè©±ä¸€è¦§ã‚’æ›´æ–°
        await loadConversations();
      }

      // ãƒãƒ£ãƒƒãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¡¨ç¤º
      function showChatInterface(user) {
        document.getElementById("no-chat-selected").classList.add("hidden");
        document.getElementById("active-chat").classList.remove("hidden");

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°
        document.getElementById("chat-user-avatar").src =
          user.profile_image_url || "/api/placeholder/40/40";
        document.getElementById(
          "chat-user-name"
        ).textContent = `${user.last_name} ${user.first_name}`;
        document.getElementById("chat-user-info").textContent = `${
          locationNames[user.location] || user.location
        }ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³`;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æ›´æ–°
        updateContactInfo(user);
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿
      async function loadMessages(userId) {
        const { data: messages, error } = await supabase
          .from("direct_messages")
          .select(
            `
                    *,
                    sender:profiles!direct_messages_sender_id_fkey(*),
                    receiver:profiles!direct_messages_receiver_id_fkey(*)
                `
          )
          .or(
            `and(sender_id.eq.${currentUser.id},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUser.id})`
          )
          .order("created_at", { ascending: true });

        if (error) {
          console.error("Error loading messages:", error);
          return;
        }

        currentMessages = messages || [];
        displayMessages();
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      function displayMessages() {
        const container = document.getElementById("messages-container");

        if (currentMessages.length === 0) {
          container.innerHTML = `
                    <div class="flex justify-center items-center h-full text-gray-500">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                            </svg>
                            <p class="mt-2 text-sm">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p>
                            <p class="text-xs text-gray-400">æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ã‚‡ã†</p>
                        </div>
                    </div>
                `;
          return;
        }

        let html = "";
        let currentDate = "";

        currentMessages.forEach((message, index) => {
          const messageDate = new Date(message.created_at).toLocaleDateString(
            "ja-JP"
          );
          const isMyMessage = message.sender_id === currentUser.id;
          const showAvatar =
            !isMyMessage &&
            (index === 0 ||
              currentMessages[index - 1].sender_id !== message.sender_id);

          // æ—¥ä»˜è¡¨ç¤º
          if (messageDate !== currentDate) {
            html += `
                        <div class="flex justify-center my-4">
                            <span class="bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded-full">${messageDate}</span>
                        </div>
                    `;
            currentDate = messageDate;
          }

          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          if (isMyMessage) {
            html += `
                        <div class="flex items-start justify-end mb-4" data-id="${message.id}" oncontextmenu="openMessageMenu(event, '${message.id}')">
                            <div class="max-w-[80%]">
                                <div class="flex items-center justify-end">
                                    <span class="text-xs text-gray-500">${formatTime(
                                      message.created_at
                                    )}</span>
                                </div>
                                <div class="bg-blue-600 text-white rounded-lg p-3 mt-1">
                                    ${
                                      typeof message.file_url === "string" &&
                                      message.file_url.match(
                                        /\.(jpg|jpeg|png|gif)$/i
                                      )
                                        ? `<img loading="lazy" src="${message.file_url}" class="max-w-full rounded">`
                                        : typeof message.file_url === "string"
                                        ? `<a href="${message.file_url}" target="_blank" class="text-blue-200 underline">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</a>`
                                        : ``
                                    }
                                    <p>${escapeHtml(message.content)}</p>
                                </div>
                                <div class="flex justify-end mt-1">
                                    <span class="text-xs text-gray-500">${
                                      message.is_read ? "æ—¢èª­" : "é€ä¿¡æ¸ˆã¿"
                                    }</span>
                                </div>
                            </div>
                        </div>
                    `;
          } else {
            html += `
                        <div class="flex items-start mb-4" data-id="${message.id}" oncontextmenu="openMessageMenu(event, '${message.id}')">
                            ${
                              showAvatar
                                ? `
                                <img loading="lazy" src="${
                                  message.sender.profile_image_url ||
                                  "/api/placeholder/32/32"
                                }" alt="${
                                    message.sender.last_name
                                  }" class="h-8 w-8 rounded-full object-cover mr-2">
                            `
                                : '<div class="w-10"></div>'
                            }
                            <div class="max-w-[80%]">
                                ${
                                  showAvatar
                                    ? `
                                    <div class="flex items-center">
                                        <span class="text-sm font-medium text-gray-900 mr-2">${
                                          message.sender.last_name
                                        } ${message.sender.first_name}</span>
                                        <span class="text-xs text-gray-500">${formatTime(
                                          message.created_at
                                        )}</span>
                                    </div>
                                `
                                    : `
                                    <div class="flex items-center">
                                        <span class="text-xs text-gray-500">${formatTime(
                                          message.created_at
                                        )}</span>
                                    </div>
                                `
                                }
                                <div class="bg-gray-100 rounded-lg p-3 mt-1">
                                    ${
                                    typeof message.file_url === "string"
                                        ? `
                                        <div class="mb-2">
                                            ${
                                                message.file_url.match(/\.(jpg|jpeg|png|gif)$/i)
                                                ? `<img loading="lazy" src="${message.file_url}" alt="ç”»åƒ" class="max-w-full rounded">`
                                                : `<a href="${message.file_url}" target="_blank" class="text-blue-600 underline">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</a>`
                                            }
                                        </div>
                                    `
                                        : ""
                                    }
                                    <p class="text-gray-800">${
                                      escapeHtml(message.content)
                                    }</p>
                                </div>
                            </div>
                        </div>
                    `;
          }
        });

        container.innerHTML = html;
        scrollToBottom();
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
      async function sendMessage(content, fileUrl = null) {
        if (!currentChatUser || (!content.trim() && !fileUrl)) return;

        const messageData = composeMessage(
          currentUser.id,
          currentChatUser.id,
          content,
          fileUrl
        );

        try {
          await sendMessageAPI(supabase, messageData);
        } catch (error) {
          console.error("Error sending message:", error);
          alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
          return;
        }

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
        document.getElementById("message-input").value = "";

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
        await loadMessages(currentChatUser.id);

        // ä¼šè©±ä¸€è¦§ã‚’æ›´æ–°
        await loadConversations();

        // é€šçŸ¥ã‚’ä½œæˆ
        await supabase.from("notifications").insert({
          user_id: currentChatUser.id,
          type: "message",
          title: "æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
          content: `${userProfile.last_name} ${userProfile.first_name}ã•ã‚“ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šãã¾ã—ãŸ`,
          related_id: currentUser.id,
        });
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      async function uploadFile(file, type = "files") {
        const fileExt = file.name.split(".").pop();
        const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;
        const filePath = `messages/${type}/${fileName}`;

        const { error: uploadError } = await supabase.storage
          .from("message-files")
          .upload(filePath, file);

        if (uploadError) {
          console.error("Upload error:", uploadError);
          throw new Error("ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }

        const { data } = supabase.storage
          .from("message-files")
          .getPublicUrl(filePath);

        return data.publicUrl;
      }

      // æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¢èª­ã«ã™ã‚‹
      async function markMessagesAsRead(senderId) {
        await supabase
          .from("direct_messages")
          .update({ is_read: true })
          .eq("sender_id", senderId)
          .eq("receiver_id", currentUser.id)
          .eq("is_read", false);
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
      async function searchUsers(query) {
        if (!query.trim()) return [];

        const { data: users } = await supabase
          .from("profiles")
          .select("*")
          .neq("id", currentUser.id)
          .or(`first_name.ilike.%${query}%,last_name.ilike.%${query}%`)
          .limit(10);

        return users || [];
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°
      function updateContactInfo(user) {
        const container = document.getElementById("contact-info-content");

        container.innerHTML = `
                <div class="flex justify-center">
                    <img loading="lazy" src="${
                      user.profile_image_url || "/api/placeholder/96/96"
                    }" alt="${user.last_name} ${
          user.first_name
        }" class="h-24 w-24 rounded-full object-cover">
                </div>
                <h3 class="font-medium text-lg text-gray-900 text-center mt-4">${
                  user.last_name
                } ${user.first_name}</h3>
                <p class="text-sm text-gray-600 text-center mt-1">${
                  locationNames[user.location] || user.location
                }</p>
                <div class="mt-2 flex justify-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>
                </div>
                
                <div class="mt-6 flex justify-center space-x-2">
                    <button type="button" class="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-200" onclick="startCall('video')" title="ãƒ“ãƒ‡ã‚ªé€šè©±">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <button type="button" class="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-200" onclick="startCall('voice')" title="éŸ³å£°é€šè©±">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                    </button>
                    <a href="profile-detail.html?user=${
                      user.id
                    }" class="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-200" title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </a>
                </div>
                
                ${
                  user.bio
                    ? `
                    <div class="mt-6">
                        <h4 class="font-medium text-gray-900 mb-2">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h4>
                        <p class="text-sm text-gray-600">${user.bio}</p>
                    </div>
                `
                    : ""
                }
                
                ${
                  user.skills
                    ? `
                    <div class="mt-4">
                        <h4 class="font-medium text-gray-900 mb-2">ã‚¹ã‚­ãƒ«ãƒ»èˆˆå‘³</h4>
                        <div class="flex flex-wrap gap-1">
                            ${user.skills
                              .slice(0, 5)
                              .map(
                                (skill) => `
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${skill}</span>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `
                    : ""
                }
                
                <div class="mt-8 flex flex-col gap-2">
                    <button class="flex items-center justify-center px-4 py-2 border border-blue-600 rounded-lg text-blue-600 font-medium hover:bg-blue-50 transition duration-200">
                        <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                        ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
                    </button>
                    <button class="flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition duration-200">
                        <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" />
                        </svg>
                        å ±å‘Šã™ã‚‹
                    </button>
                </div>
            `;
      }

      // é€šè©±é–‹å§‹
      function startCall(type) {
        if (!currentChatUser) return;

        document.getElementById("call-user-avatar").src =
          currentChatUser.profile_image_url || "/api/placeholder/96/96";
        document.getElementById(
          "call-user-name"
        ).textContent = `${currentChatUser.last_name} ${currentChatUser.first_name}`;
        document.getElementById("call-status").textContent =
          type === "video" ? "ãƒ“ãƒ‡ã‚ªé€šè©±ã‚’ç™ºä¿¡ä¸­..." : "éŸ³å£°é€šè©±ã‚’ç™ºä¿¡ä¸­...";

        openModal("call-modal");

        // æ¨¡æ“¬çš„ãªæ¥ç¶š
        setTimeout(() => {
          document.getElementById("call-status").textContent = "æ¥ç¶šã•ã‚Œã¾ã—ãŸ";
        }, 2000);
      }

      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°è¨­å®š
      function setupRealtimeSubscriptions() {
        supabase
          .channel("messages-channel")
          .on(
            "postgres_changes",
            {
              event: "INSERT",
              schema: "public",
              table: "direct_messages",
            },
            (payload) => {
              if (
                currentChatUser &&
                (payload.new.sender_id === currentChatUser.id ||
                  payload.new.receiver_id === currentChatUser.id)
              ) {
                loadMessages(currentChatUser.id);
                if (payload.new.sender_id === currentChatUser.id) {
                  markMessagesAsRead(currentChatUser.id);
                }
              }
              loadConversations();
            }
          )
          .on(
            "postgres_changes",
            {
              event: "UPDATE",
              schema: "public",
              table: "direct_messages",
            },
            (payload) => {
              if (
                currentChatUser &&
                (payload.new.sender_id === currentChatUser.id ||
                  payload.new.receiver_id === currentChatUser.id)
              ) {
                loadMessages(currentChatUser.id);
              }
              loadConversations();
            }
          )
          .on(
            "postgres_changes",
            {
              event: "DELETE",
              schema: "public",
              table: "direct_messages",
            },
            (payload) => {
              if (
                currentChatUser &&
                (payload.old.sender_id === currentChatUser.id ||
                  payload.old.receiver_id === currentChatUser.id)
              ) {
                loadMessages(currentChatUser.id);
              }
              loadConversations();
            }
          )
          .subscribe();
      }

      // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
      function formatTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString("ja-JP", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function formatMessageTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return "ä»Š";
        if (diff < 3600000) return `${Math.floor(diff / 60000)}åˆ†å‰`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}æ™‚é–“å‰`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)}æ—¥å‰`;

        return date.toLocaleDateString("ja-JP");
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function scrollToBottom() {
        const container = document.getElementById("messages-container");
        container.scrollTop = container.scrollHeight;
      }

      function showLoadingConversations() {
        document
          .getElementById("loading-conversations")
          .classList.remove("hidden");
        document
          .getElementById("conversations-content")
          .classList.add("hidden");
        document.getElementById("no-conversations").classList.add("hidden");
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      document
        .querySelector(".mobile-menu-button")
        .addEventListener("click", function () {
          const menu = document.getElementById("mobile-menu");
          const expanded = menu.classList.toggle("hidden") ? false : true;
          this.setAttribute("aria-expanded", expanded);
        });

      document
        .getElementById("user-menu-button")
        .addEventListener("click", function () {
          document.getElementById("user-menu").classList.toggle("hidden");
        });

      window.addEventListener("click", function (e) {
        if (!document.getElementById("user-menu-button").contains(e.target)) {
          document.getElementById("user-menu").classList.add("hidden");
        }
      });

      // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ãƒªã‚¹ãƒˆè¡¨ç¤º/éè¡¨ç¤º
      document
        .getElementById("toggle-contact-list")
        .addEventListener("click", function () {
          const contactList = document.getElementById("contact-list");
          const chatContent = document.getElementById("chat-content");

          if (contactList.classList.contains("hidden")) {
            contactList.classList.remove("hidden");
            chatContent.classList.add("hidden");
          } else {
            contactList.classList.add("hidden");
            chatContent.classList.remove("hidden");
          }
        });

      document
        .getElementById("toggle-contact-info")
        .addEventListener("click", function () {
          const contactInfo = document.getElementById("contact-info");
          const chatContent = document.getElementById("chat-content");

          if (contactInfo.classList.contains("hidden")) {
            contactInfo.classList.remove("hidden");
            chatContent.classList.add("hidden");
          } else {
            contactInfo.classList.add("hidden");
            chatContent.classList.remove("hidden");
          }
        });

      document
        .getElementById("show-contact-info")
        .addEventListener("click", function () {
          const contactInfo = document.getElementById("contact-info");
          contactInfo.classList.toggle("hidden");
        });

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
      document
        .getElementById("send-message-btn")
        .addEventListener("click", function () {
          const input = document.getElementById("message-input");
          const content = input.value.trim();
          if (content) {
            sendMessage(content);
          }
        });

      document
        .getElementById("message-input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            const content = this.value.trim();
            if (content) {
              sendMessage(content);
            }
          }
        });

      // ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜
      document
        .getElementById("attach-file-btn")
        .addEventListener("click", function () {
          document.getElementById("file-input").click();
        });

      document
        .getElementById("attach-image-btn")
        .addEventListener("click", function () {
          document.getElementById("image-input").click();
        });

      document
        .getElementById("file-input")
        .addEventListener("change", async function (e) {
          const file = e.target.files[0];
          if (file) {
            try {
              const fileUrl = await uploadFile(file, "files");
              await sendMessage(`ãƒ•ã‚¡ã‚¤ãƒ«: ${file.name}`, fileUrl);
            } catch (error) {
              alert(error.message);
            }
            this.value = "";
          }
        });

      document
        .getElementById("image-input")
        .addEventListener("change", async function (e) {
          const file = e.target.files[0];
          if (file) {
            try {
              const fileUrl = await uploadFile(file, "images");
              await sendMessage("ç”»åƒã‚’é€ä¿¡ã—ã¾ã—ãŸ", fileUrl);
            } catch (error) {
              alert(error.message);
            }
            this.value = "";
          }
        });

      // é€šè©±é–¢é€£
      document
        .getElementById("video-call-btn")
        .addEventListener("click", () => startCall("video"));
      document
        .getElementById("voice-call-btn")
        .addEventListener("click", () => startCall("voice"));
      document
        .getElementById("end-call-btn")
        .addEventListener("click", function () {
          closeModal("call-modal");
        });

      // æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«
      document
        .getElementById("new-message-btn")
        .addEventListener("click", function () {
          openModal("new-message-modal", this);
        });

      document
        .getElementById("close-new-message-modal")
        .addEventListener("click", function () {
          closeModal("new-message-modal");
        });

      document
        .getElementById("cancel-new-message")
        .addEventListener("click", function () {
          closeModal("new-message-modal");
        });

      // å®›å…ˆæ¤œç´¢
      document
        .getElementById("recipient-search")
        .addEventListener("input", async function (e) {
          const query = e.target.value.trim();
          const suggestionsContainer = document.getElementById(
            "recipient-suggestions"
          );

          if (query.length < 2) {
            suggestionsContainer.classList.add("hidden");
            return;
          }

          const users = await searchUsers(query);

          if (users.length === 0) {
            suggestionsContainer.innerHTML =
              '<div class="p-2 text-gray-500 text-sm">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
            suggestionsContainer.classList.remove("hidden");
            return;
          }

          suggestionsContainer.innerHTML = users
            .map(
              (user) => `
                <div class="p-2 hover:bg-gray-100 cursor-pointer flex items-center" onclick="selectRecipient('${
                  user.id
                }')">
                    <img loading="lazy" src="${
                      user.profile_image_url || "/api/placeholder/32/32"
                    }" alt="" class="w-8 h-8 rounded-full object-cover mr-2">
                    <div>
                        <div class="text-sm font-medium">${user.last_name} ${
                user.first_name
              }</div>
                        <div class="text-xs text-gray-500">${
                          locationNames[user.location] || user.location
                        }</div>
                    </div>
                </div>
            `
            )
            .join("");
          suggestionsContainer.classList.remove("hidden");
        });

      // å®›å…ˆé¸æŠ
      function selectRecipient(userId) {
        const users = document.querySelectorAll("#recipient-suggestions > div");
        users.forEach((user) => {
          if (user.onclick && user.onclick.toString().includes(userId)) {
            selectedRecipient = userId;
            document.getElementById("recipient-search").value =
              user.querySelector(".text-sm").textContent;
            document
              .getElementById("recipient-suggestions")
              .classList.add("hidden");
          }
        });
      }

      // æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
      document
        .getElementById("send-new-message")
        .addEventListener("click", async function () {
          const message = document
            .getElementById("initial-message")
            .value.trim();

          if (!selectedRecipient || !message) {
            alert("å®›å…ˆã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
          }

          try {
            await supabase.from("direct_messages").insert({
              sender_id: currentUser.id,
              receiver_id: selectedRecipient,
              content: message,
              is_read: false,
            });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ã€æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã
            document
              .getElementById("new-message-modal")
              .classList.add("hidden");
            document.getElementById("recipient-search").value = "";
            document.getElementById("initial-message").value = "";
            selectedRecipient = null;

            await loadConversations();
            await startChatWithUser(selectedRecipient);
          } catch (error) {
            console.error("Error sending message:", error);
            alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        });

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document
        .getElementById("logout-link")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await supabase.auth.signOut();
          window.location.href = "login.html?message=logout";
        });

      document
        .querySelector(".logout-link-mobile")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await supabase.auth.signOut();
          window.location.href = "login.html?message=logout";
        });

      // åˆæœŸè¡¨ç¤ºè¨­å®šï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰
      function handleResize() {
        if (window.innerWidth < 768) {
          document.getElementById("contact-list").classList.remove("hidden");
          document.getElementById("chat-content").classList.add("hidden");
          document.getElementById("contact-info").classList.add("hidden");
        } else {
          document.getElementById("contact-list").classList.remove("hidden");
          document.getElementById("chat-content").classList.remove("hidden");
        }
      }

      window.addEventListener("resize", handleResize);
      handleResize();

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
      window.selectConversation = selectConversation;
      window.selectRecipient = selectRecipient;
      window.startCall = startCall;
    </script>
    <div id="message-menu" class="hidden absolute bg-white border rounded shadow z-50">
      <button id="edit-msg-btn" class="block w-full px-4 py-2 text-left hover:bg-gray-100">ç·¨é›†</button>
      <button id="delete-msg-btn" class="block w-full px-4 py-2 text-left text-red-600 hover:bg-gray-100">å‰Šé™¤</button>
    </div>
    <script>
      let targetMessageId = null;
      function openMessageMenu(event, id) {
        event.preventDefault();
        targetMessageId = id;
        const menu = document.getElementById('message-menu');
        menu.style.top = event.clientY + 'px';
        menu.style.left = event.clientX + 'px';
        menu.classList.remove('hidden');
      }
      document.addEventListener('click', () => {
        document.getElementById('message-menu').classList.add('hidden');
      });
      document.getElementById('edit-msg-btn').addEventListener('click', async () => {
        document.getElementById('message-menu').classList.add('hidden');
        const msg = currentMessages.find(m => m.id === targetMessageId);
        if (!msg) return;
        const text = prompt('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†', msg.content);
        if (text !== null) {
          await updateDirectMessage(supabase, targetMessageId, { content: text });
          if (currentChatUser) {
            await loadMessages(currentChatUser.id);
            await loadConversations();
          }
        }
      });
      document.getElementById('delete-msg-btn').addEventListener('click', async () => {
        document.getElementById('message-menu').classList.add('hidden');
        if (confirm('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
          await deleteDirectMessage(supabase, targetMessageId);
          if (currentChatUser) {
            await loadMessages(currentChatUser.id);
            await loadConversations();
          }
        }
      });
    </script>
    <script src="js/theme.js"></script>
    <script src="accessibility.js"></script>
  </body>
</html>
