<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer" />
    <title>メッセージ - スタートアップコネクト</title>
    <link rel="stylesheet" href="styles/styles.css" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans JP", sans-serif;
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 5px;
      }
      .scrollbar-thin::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 5px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }
      .chat-height {
        height: calc(100vh - 200px);
      }
      .messages-height {
        height: calc(100vh - 300px);
      }
      .skeleton {
        animation: shimmer 1.5s infinite;
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
      }
      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 dark:bg-dark-bg dark:text-dark-text min-h-screen">
    <!-- ナビゲーションバー -->
    <header class="bg-white dark:bg-dark-card dark:text-dark-text shadow-md sticky top-0 z-20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <div class="flex-shrink-0 flex items-center">
              <a href="index.html">
                <svg
                  class="h-8 w-8 text-blue-600"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </a>
              <a
                href="dashboard.html"
                class="ml-2 text-xl font-bold text-gray-800"
                >スタートアップコネクト</a
              >
            </div>
            <nav class="hidden md:ml-6 md:flex space-x-4">
              <a
                href="dashboard.html"
                class="text-gray-500 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
                >ホーム</a
              >
              <a
                href="search.html"
                class="text-gray-500 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
                >検索</a
              >
              <a
                href="messages.html"
                class="bg-blue-50 text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
                >メッセージ</a
              >
              <a
                href="groups.html"
                class="text-gray-500 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
                >グループ</a
              >
              <a
                href="events.html"
                class="text-gray-500 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
                >イベント</a
              >
            </nav>
          </div>
          <div class="hidden md:flex items-center">
            <button
              type="button"
              id="notification-button"
              onclick="location.href='notifications.html';"
              class="relative p-1 rounded-full text-gray-500 hover:text-blue-600 focus:outline-none"
            >
              <span class="sr-only">通知を見る</span>
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                ></path>
              </svg>
              <span
                id="notification-dot"
                class="hidden absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-500"
              ></span>
            </button>

            <button id="theme-toggle" aria-label="Toggle dark mode" class="ml-2 p-2 rounded-md text-gray-500 hover:text-blue-600 focus:outline-none">
              <svg class="h-6 w-6 dark:hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/>
              </svg>
              <svg class="h-6 w-6 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/>
              </svg>
            </button>

            <div class="ml-3 relative">
              <div class="flex items-center">
                <button
                  type="button"
                  class="bg-gray-800 flex text-sm rounded-full focus:outline-none"
                  id="user-menu-button"
                >
                  <span class="sr-only">メニューを開く</span>
                  <img
                    id="user-avatar"
                    class="h-8 w-8 rounded-full object-cover"
                    src="/api/placeholder/32/32"
                    alt="プロフィール"
                  />
                </button>
                <div class="ml-2 hidden md:block">
                  <div id="user-name" class="text-sm font-medium text-gray-800">
                    -
                  </div>
                  <div id="user-location" class="text-xs text-gray-500">-</div>
                </div>
              </div>

              <div
                id="user-menu"
                class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-30"
              >
                <a
                  href="profile.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >プロフィール</a
                >
                <a
                  href="settings.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >設定</a
                >
                <a
                  href="#"
                  id="logout-link"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >ログアウト</a
                >
              </div>
            </div>
          </div>

          <div class="flex md:hidden items-center">
            <button
              type="button"
              class="mobile-menu-button text-gray-500 hover:text-blue-600 focus:outline-none"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- モバイルメニュー -->
      <div class="mobile-menu hidden md:hidden bg-white border-t">
        <a
          href="dashboard.html"
          class="block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >ホーム</a
        >
        <a
          href="search.html"
          class="block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >検索</a
        >
        <a href="messages.html" class="block px-4 py-2 bg-blue-50 text-blue-600"
          >メッセージ</a
        >
        <a
          href="groups.html"
          class="block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >グループ</a
        >
        <a
          href="events.html"
          class="block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >イベント</a
        >
        <div class="border-t border-gray-200 my-1"></div>
        <a
          href="profile.html"
          class="block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >プロフィール</a
        >
        <a
          href="settings.html"
          class="block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >設定</a
        >
        <a
          href="#"
          class="logout-link-mobile block px-4 py-2 text-gray-500 hover:bg-gray-100"
          >ログアウト</a
        >
      </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">メッセージ</h1>
        <div class="flex gap-2">
          <button
            id="new-message-btn"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition duration-200 flex items-center"
          >
            <svg
              class="h-5 w-5 mr-1"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
              />
            </svg>
            新規メッセージ
          </button>
          <a
            href="groups.html"
            class="border border-blue-600 text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition duration-200 flex items-center"
          >
            <svg
              class="h-5 w-5 mr-1"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
              />
            </svg>
            グループチャット
          </a>
        </div>
      </div>

      <!-- メッセージセクション -->
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="flex flex-col md:flex-row h-full">
          <!-- モバイル用のトグルボタン -->
          <div
            class="md:hidden flex justify-between items-center p-4 border-b border-gray-200"
          >
            <button
              id="toggle-contact-list"
              class="text-gray-600 hover:text-blue-600"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                ></path>
              </svg>
            </button>
            <h2 class="text-lg font-medium text-gray-900">メッセージ</h2>
            <button
              id="toggle-contact-info"
              class="text-gray-600 hover:text-blue-600"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
            </button>
          </div>

          <!-- ユーザー一覧 -->
          <div
            id="contact-list"
            class="w-full md:w-80 lg:w-96 border-r border-gray-200 flex flex-col"
          >
            <div class="p-4 border-b border-gray-200">
              <div class="relative">
                <input
                  type="text"
                  id="search-users"
                  class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="ユーザーを検索"
                />
                <div
                  class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                >
                  <svg
                    class="h-5 w-5 text-gray-400"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
              </div>
            </div>

            <div
              id="conversations-list"
              class="overflow-y-auto scrollbar-thin chat-height"
            >
              <!-- 会話一覧がここに動的に生成される -->
              <div id="loading-conversations" class="p-4">
                <div class="space-y-3">
                  <div class="flex items-center space-x-3">
                    <div class="skeleton w-12 h-12 rounded-full"></div>
                    <div class="flex-1">
                      <div class="skeleton h-4 w-3/4 mb-2"></div>
                      <div class="skeleton h-3 w-1/2"></div>
                    </div>
                  </div>
                  <div class="flex items-center space-x-3">
                    <div class="skeleton w-12 h-12 rounded-full"></div>
                    <div class="flex-1">
                      <div class="skeleton h-4 w-3/4 mb-2"></div>
                      <div class="skeleton h-3 w-1/2"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div id="conversations-content" class="hidden">
                <!-- 実際の会話一覧はここに表示 -->
              </div>
              <div
                id="no-conversations"
                class="hidden p-4 text-center text-gray-500"
              >
                <svg
                  class="mx-auto h-12 w-12 text-gray-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                  />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">
                  メッセージがありません
                </h3>
                <p class="mt-1 text-sm text-gray-500">
                  新しいメッセージを送信して会話を始めましょう。
                </p>
              </div>
            </div>
          </div>

          <!-- チャット本文 -->
          <div id="chat-content" class="flex-1 flex flex-col">
            <!-- チャット未選択状態 -->
            <div
              id="no-chat-selected"
              class="flex-1 flex items-center justify-center text-gray-500"
            >
              <div class="text-center">
                <svg
                  class="mx-auto h-16 w-16 text-gray-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                  />
                </svg>
                <h3 class="mt-4 text-lg font-medium text-gray-900">
                  会話を選択してください
                </h3>
                <p class="mt-2 text-sm text-gray-500">
                  左側のリストから会話を選択するか、新しいメッセージを開始してください。
                </p>
              </div>
            </div>

            <!-- アクティブなチャット -->
            <div id="active-chat" class="hidden flex-1 flex flex-col">
              <div
                class="flex items-center justify-between p-4 border-b border-gray-200"
              >
                <div class="flex items-center">
                  <div class="relative">
                    <img
                      id="chat-user-avatar"
                      class="h-10 w-10 rounded-full object-cover"
                      src="/api/placeholder/40/40"
                      alt=""
                    />
                    <span
                      id="chat-user-status"
                      class="absolute bottom-0 right-0 block h-3 w-3 rounded-full bg-gray-300 border-2 border-white"
                    ></span>
                  </div>
                  <div class="ml-3">
                    <h3 id="chat-user-name" class="font-medium text-gray-900">
                      -
                    </h3>
                    <div id="chat-user-info" class="text-xs text-gray-500">
                      -
                    </div>
                  </div>
                </div>
                <div class="flex">
                  <button
                    type="button"
                    class="p-2 text-gray-500 hover:text-blue-600 rounded-full"
                    id="video-call-btn"
                    title="ビデオ通話"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                      />
                    </svg>
                  </button>
                  <button
                    type="button"
                    class="p-2 text-gray-500 hover:text-blue-600 rounded-full"
                    id="voice-call-btn"
                    title="音声通話"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                      />
                    </svg>
                  </button>
                  <button
                    type="button"
                    class="p-2 text-gray-500 hover:text-blue-600 rounded-full"
                    title="その他"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                      />
                    </svg>
                  </button>
                  <button
                    id="show-contact-info"
                    type="button"
                    class="p-2 text-gray-500 hover:text-blue-600 rounded-full md:hidden lg:block"
                    title="ユーザー情報"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                  </button>
                </div>
              </div>

              <!-- メッセージ表示エリア -->
              <div
                id="messages-container"
                class="flex-1 overflow-y-auto p-4 scrollbar-thin messages-height"
              >
                <!-- メッセージがここに動的に生成される -->
              </div>

              <!-- タイピングインジケーター -->
              <div id="typing-indicator" class="hidden px-4 py-2">
                <div class="flex items-start">
                  <img
                    id="typing-user-avatar"
                    class="h-8 w-8 rounded-full object-cover mr-2"
                    src="/api/placeholder/32/32"
                    alt=""
                  />
                  <div class="bg-gray-100 rounded-lg px-3 py-2">
                    <div class="flex space-x-1">
                      <div
                        class="w-2 h-2 rounded-full bg-gray-500 animate-bounce"
                      ></div>
                      <div
                        class="w-2 h-2 rounded-full bg-gray-500 animate-bounce"
                        style="animation-delay: 0.2s"
                      ></div>
                      <div
                        class="w-2 h-2 rounded-full bg-gray-500 animate-bounce"
                        style="animation-delay: 0.4s"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- メッセージ入力エリア -->
              <div class="border-t border-gray-200 p-4">
                <div class="flex items-center">
                  <button
                    type="button"
                    id="attach-file-btn"
                    class="p-2 text-gray-500 hover:text-blue-600 rounded-full"
                    title="ファイル添付"
                  >
                    <svg
                      class="h-6 w-6"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"
                      ></path>
                    </svg>
                  </button>
                  <button
                    type="button"
                    id="attach-image-btn"
                    class="p-2 text-gray-500 hover:text-blue-600 rounded-full"
                    title="画像添付"
                  >
                    <svg
                      class="h-6 w-6"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                      ></path>
                    </svg>
                  </button>
                  <div class="flex-1 mx-2">
                    <input
                      type="text"
                      id="message-input"
                      class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="メッセージを入力..."
                    />
                  </div>
                  <button
                    type="button"
                    id="send-message-btn"
                    class="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-200"
                    title="送信"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 12h14M12 5l7 7-7 7"
                      />
                    </svg>
                  </button>
                  <input
                    type="file"
                    id="file-input"
                    class="hidden"
                    accept="*/*"
                  />
                  <input
                    type="file"
                    id="image-input"
                    class="hidden"
                    accept="image/*"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- ユーザー情報サイドバー -->
          <div
            id="contact-info"
            class="hidden lg:block w-80 border-l border-gray-200"
          >
            <div class="p-4 border-b border-gray-200">
              <h3 class="font-medium text-gray-900">ユーザー情報</h3>
            </div>
            <div id="contact-info-content" class="p-4">
              <!-- ユーザー情報がここに動的に生成される -->
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- 新規メッセージモーダル -->
    <div id="new-message-modal" class="fixed inset-0 z-30 hidden" role="dialog" aria-modal="true">
      <div class="absolute inset-0 bg-gray-900 bg-opacity-50"></div>
      <div
        class="relative max-w-lg mx-auto mt-20 bg-white rounded-lg shadow-xl"
      >
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-semibold text-gray-900">新規メッセージ</h3>
            <button
              id="close-new-message-modal"
              class="text-gray-400 hover:text-gray-500"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >宛先</label
            >
            <div class="relative">
              <input
                type="text"
                id="recipient-search"
                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="ユーザー名で検索"
              />
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <svg
                  class="h-5 w-5 text-gray-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
            </div>
            <div
              id="recipient-suggestions"
              class="mt-2 hidden border border-gray-300 rounded-md max-h-48 overflow-y-auto"
            >
              <!-- ユーザー候補がここに表示される -->
            </div>
          </div>

          <div class="mb-6">
            <label
              for="initial-message"
              class="block text-sm font-medium text-gray-700 mb-2"
              >メッセージ</label
            >
            <textarea
              id="initial-message"
              rows="4"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="メッセージを入力してください"
            ></textarea>
          </div>

          <div class="flex justify-end space-x-3">
            <button
              type="button"
              id="cancel-new-message"
              class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 font-medium hover:bg-gray-50 transition duration-200"
            >
              キャンセル
            </button>
            <button
              type="button"
              id="send-new-message"
              class="px-4 py-2 bg-blue-600 text-white rounded-md font-medium hover:bg-blue-700 transition duration-200"
            >
              送信
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 通話モーダル -->
    <div id="call-modal" class="fixed inset-0 z-30 hidden" role="dialog" aria-modal="true">
      <div class="absolute inset-0 bg-gray-900 bg-opacity-75"></div>
      <div
        class="relative max-w-md mx-auto mt-20 bg-white rounded-lg shadow-xl overflow-hidden"
      >
        <div class="p-6 text-center">
          <div class="mb-6">
            <img
              id="call-user-avatar"
              src="/api/placeholder/96/96"
              alt=""
              class="h-24 w-24 rounded-full object-cover mx-auto"
            />
            <h3
              id="call-user-name"
              class="text-xl font-semibold text-gray-900 mt-4"
            >
              -
            </h3>
            <p id="call-status" class="text-gray-600 mt-2">発信中...</p>
          </div>
          <div class="flex justify-center space-x-4">
            <button
              id="mute-btn"
              class="p-4 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition duration-200"
              title="ミュート"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
                />
              </svg>
            </button>
            <button
              id="end-call-btn"
              class="p-4 bg-red-600 text-white rounded-full hover:bg-red-700 transition duration-200"
              title="通話終了"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z"
                />
              </svg>
            </button>
            <button
              id="speaker-btn"
              class="p-4 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition duration-200"
              title="スピーカー"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- フッター -->
    <footer class="bg-gray-100 py-6 mt-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center text-gray-500 text-sm">
          <p>&copy; 2024 スタートアップコネクト. All rights reserved.</p>
          <div class="mt-2 space-x-4">
            <a href="#" class="text-gray-500 hover:text-gray-700">利用規約</a>
            <a href="#" class="text-gray-500 hover:text-gray-700"
              >プライバシーポリシー</a
            >
            <a href="#" class="text-gray-500 hover:text-gray-700"
              >お問い合わせ</a
            >
          </div>
        </div>
      </div>
    </footer>

    <script type="module">
      import { composeMessage, sendMessage as sendMessageAPI } from './js/message.js';
      // Supabase設定
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__ENV__;
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // グローバル変数
      let currentUser = null;
      let userProfile = null;
      let currentChatUser = null;
      let conversations = [];
      let currentMessages = [];
      let selectedRecipient = null;
      let typingTimeout = null;

      // 地域名マッピング
      const locationNames = {
        hokkaido: "北海道",
        aomori: "青森県",
        iwate: "岩手県",
        miyagi: "宮城県",
        akita: "秋田県",
        yamagata: "山形県",
        fukushima: "福島県",
        ibaraki: "茨城県",
        tochigi: "栃木県",
        gunma: "群馬県",
        saitama: "埼玉県",
        chiba: "千葉県",
        tokyo: "東京都",
        kanagawa: "神奈川県",
        niigata: "新潟県",
        toyama: "富山県",
        ishikawa: "石川県",
        fukui: "福井県",
        yamanashi: "山梨県",
        nagano: "長野県",
        gifu: "岐阜県",
        shizuoka: "静岡県",
        aichi: "愛知県",
        mie: "三重県",
        shiga: "滋賀県",
        kyoto: "京都府",
        osaka: "大阪府",
        hyogo: "兵庫県",
        nara: "奈良県",
        wakayama: "和歌山県",
        tottori: "鳥取県",
        shimane: "島根県",
        okayama: "岡山県",
        hiroshima: "広島県",
        yamaguchi: "山口県",
        tokushima: "徳島県",
        kagawa: "香川県",
        ehime: "愛媛県",
        kochi: "高知県",
        fukuoka: "福岡県",
        saga: "佐賀県",
        nagasaki: "長崎県",
        kumamoto: "熊本県",
        oita: "大分県",
        miyazaki: "宮崎県",
        kagoshima: "鹿児島県",
        okinawa: "沖縄県",
      };

      // ページ読み込み時の初期化
      window.addEventListener("load", async () => {
        await checkAuth();
        await loadConversations();
        setupRealtimeSubscriptions();

        // URLパラメータから特定のユーザーとのチャットを開く
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get("user");
        if (userId) {
          await startChatWithUser(userId);
        }
      });

      // 認証チェック
      async function checkAuth() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = "login.html";
          return;
        }
        currentUser = user;
        await loadUserProfile();
      }

      // ユーザープロフィール読み込み
      async function loadUserProfile() {
        const { data: profile } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", currentUser.id)
          .single();

        if (profile) {
          userProfile = profile;
          updateUserInfo(profile);
        }
      }

      // ユーザー情報更新
      function updateUserInfo(profile) {
        document.getElementById(
          "user-name"
        ).textContent = `${profile.last_name} ${profile.first_name}`;
        document.getElementById("user-location").textContent =
          locationNames[profile.location] || profile.location;
        if (profile.profile_image_url) {
          document.getElementById("user-avatar").src =
            profile.profile_image_url;
        }
      }

      // 会話一覧読み込み
      async function loadConversations() {
        showLoadingConversations();

        // 送信したメッセージ
        const { data: sentMessages } = await supabase
          .from("direct_messages")
          .select(
            `
                    *,
                    receiver:profiles!direct_messages_receiver_id_fkey(*)
                `
          )
          .eq("sender_id", currentUser.id)
          .order("created_at", { ascending: false });

        // 受信したメッセージ
        const { data: receivedMessages } = await supabase
          .from("direct_messages")
          .select(
            `
                    *,
                    sender:profiles!direct_messages_sender_id_fkey(*)
                `
          )
          .eq("receiver_id", currentUser.id)
          .order("created_at", { ascending: false });

        // 会話を整理
        const conversationMap = new Map();

        // 送信メッセージの処理
        sentMessages?.forEach((message) => {
          const otherId = message.receiver_id;
          if (
            !conversationMap.has(otherId) ||
            new Date(message.created_at) >
              new Date(conversationMap.get(otherId).lastMessage.created_at)
          ) {
            conversationMap.set(otherId, {
              user: message.receiver,
              lastMessage: message,
              unreadCount: 0,
              isSentByMe: true,
            });
          }
        });

        // 受信メッセージの処理
        receivedMessages?.forEach((message) => {
          const otherId = message.sender_id;
          const existing = conversationMap.get(otherId);
          if (
            !existing ||
            new Date(message.created_at) >
              new Date(existing.lastMessage.created_at)
          ) {
            const unreadCount = receivedMessages.filter(
              (m) => m.sender_id === otherId && !m.is_read
            ).length;

            conversationMap.set(otherId, {
              user: message.sender,
              lastMessage: message,
              unreadCount: unreadCount,
              isSentByMe: false,
            });
          }
        });

        conversations = Array.from(conversationMap.values()).sort(
          (a, b) =>
            new Date(b.lastMessage.created_at) -
            new Date(a.lastMessage.created_at)
        );

        displayConversations();
      }

      // 会話一覧表示
      function displayConversations() {
        const container = document.getElementById("conversations-content");
        const loadingElement = document.getElementById("loading-conversations");
        const noConversationsElement =
          document.getElementById("no-conversations");

        loadingElement.classList.add("hidden");

        if (conversations.length === 0) {
          container.classList.add("hidden");
          noConversationsElement.classList.remove("hidden");
          return;
        }

        container.classList.remove("hidden");
        noConversationsElement.classList.add("hidden");

        container.innerHTML = conversations
          .map((conv) => {
            const isActive = currentChatUser?.id === conv.user.id;
            const truncatedMessage =
              conv.lastMessage.content.length > 50
                ? conv.lastMessage.content.substring(0, 50) + "..."
                : conv.lastMessage.content;

            return `
                    <div class="px-4 py-3 ${
                      isActive
                        ? "bg-blue-50 border-l-4 border-blue-600"
                        : "bg-white"
                    } flex items-start hover:bg-gray-50 transition duration-150 cursor-pointer" onclick="selectConversation('${
              conv.user.id
            }')">
                        <div class="relative flex-shrink-0">
                            <img class="w-12 h-12 rounded-full object-cover" src="${
                              conv.user.profile_image_url ||
                              "/api/placeholder/48/48"
                            }" alt="${conv.user.last_name} ${
              conv.user.first_name
            }">
                            <span class="absolute bottom-0 right-0 block h-3 w-3 rounded-full bg-green-500 border-2 border-white"></span>
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="flex justify-between items-baseline">
                                <h3 class="text-sm font-medium text-gray-900">${
                                  conv.user.last_name
                                } ${conv.user.first_name}</h3>
                                <span class="text-xs text-gray-500">${formatMessageTime(
                                  conv.lastMessage.created_at
                                )}</span>
                            </div>
                            <p class="text-sm text-gray-600 line-clamp-1 ${
                              !conv.isSentByMe && conv.unreadCount > 0
                                ? "font-semibold"
                                : ""
                            }">
                                ${
                                  conv.isSentByMe ? "あなた: " : ""
                                }${truncatedMessage}
                            </p>
                            ${
                              conv.unreadCount > 0
                                ? `
                                <div class="mt-1">
                                    <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-blue-600 rounded-full">${conv.unreadCount}</span>
                                </div>
                            `
                                : ""
                            }
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // 会話選択
      async function selectConversation(userId) {
        await startChatWithUser(userId);
      }

      // 特定ユーザーとのチャット開始
      async function startChatWithUser(userId) {
        // ユーザー情報を取得
        const { data: user } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", userId)
          .single();

        if (!user) {
          console.error("User not found");
          return;
        }

        currentChatUser = user;

        // チャットUIを表示
        showChatInterface(user);

        // メッセージを読み込み
        await loadMessages(userId);

        // 未読メッセージを既読にする
        await markMessagesAsRead(userId);

        // 会話一覧を更新
        await loadConversations();
      }

      // チャットインターフェース表示
      function showChatInterface(user) {
        document.getElementById("no-chat-selected").classList.add("hidden");
        document.getElementById("active-chat").classList.remove("hidden");

        // ユーザー情報を更新
        document.getElementById("chat-user-avatar").src =
          user.profile_image_url || "/api/placeholder/40/40";
        document.getElementById(
          "chat-user-name"
        ).textContent = `${user.last_name} ${user.first_name}`;
        document.getElementById("chat-user-info").textContent = `${
          locationNames[user.location] || user.location
        }・オンライン`;

        // ユーザー情報サイドバーを更新
        updateContactInfo(user);
      }

      // メッセージ読み込み
      async function loadMessages(userId) {
        const { data: messages, error } = await supabase
          .from("direct_messages")
          .select(
            `
                    *,
                    sender:profiles!direct_messages_sender_id_fkey(*),
                    receiver:profiles!direct_messages_receiver_id_fkey(*)
                `
          )
          .or(
            `and(sender_id.eq.${currentUser.id},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUser.id})`
          )
          .order("created_at", { ascending: true });

        if (error) {
          console.error("Error loading messages:", error);
          return;
        }

        currentMessages = messages || [];
        displayMessages();
      }

      // メッセージ表示
      function displayMessages() {
        const container = document.getElementById("messages-container");

        if (currentMessages.length === 0) {
          container.innerHTML = `
                    <div class="flex justify-center items-center h-full text-gray-500">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                            </svg>
                            <p class="mt-2 text-sm">まだメッセージがありません</p>
                            <p class="text-xs text-gray-400">最初のメッセージを送信しましょう</p>
                        </div>
                    </div>
                `;
          return;
        }

        let html = "";
        let currentDate = "";

        currentMessages.forEach((message, index) => {
          const messageDate = new Date(message.created_at).toLocaleDateString(
            "ja-JP"
          );
          const isMyMessage = message.sender_id === currentUser.id;
          const showAvatar =
            !isMyMessage &&
            (index === 0 ||
              currentMessages[index - 1].sender_id !== message.sender_id);

          // 日付表示
          if (messageDate !== currentDate) {
            html += `
                        <div class="flex justify-center my-4">
                            <span class="bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded-full">${messageDate}</span>
                        </div>
                    `;
            currentDate = messageDate;
          }

          // メッセージ
          if (isMyMessage) {
            html += `
                        <div class="flex items-start justify-end mb-4">
                            <div class="max-w-[80%]">
                                <div class="flex items-center justify-end">
                                    <span class="text-xs text-gray-500">${formatTime(
                                      message.created_at
                                    )}</span>
                                </div>
                                <div class="bg-blue-600 text-white rounded-lg p-3 mt-1">
                                    ${
                                      typeof message.file_url === "string" &&
                                      message.file_url.match(
                                        /\.(jpg|jpeg|png|gif)$/i
                                      )
                                        ? `<img src="${message.file_url}" class="max-w-full rounded">`
                                        : typeof message.file_url === "string"
                                        ? `<a href="${message.file_url}" target="_blank" class="text-blue-200 underline">📎 ファイルを開く</a>`
                                        : ``
                                    }
                                    <p>${escapeHtml(message.content)}</p>
                                </div>
                                <div class="flex justify-end mt-1">
                                    <span class="text-xs text-gray-500">${
                                      message.is_read ? "既読" : "送信済み"
                                    }</span>
                                </div>
                            </div>
                        </div>
                    `;
          } else {
            html += `
                        <div class="flex items-start mb-4">
                            ${
                              showAvatar
                                ? `
                                <img src="${
                                  message.sender.profile_image_url ||
                                  "/api/placeholder/32/32"
                                }" alt="${
                                    message.sender.last_name
                                  }" class="h-8 w-8 rounded-full object-cover mr-2">
                            `
                                : '<div class="w-10"></div>'
                            }
                            <div class="max-w-[80%]">
                                ${
                                  showAvatar
                                    ? `
                                    <div class="flex items-center">
                                        <span class="text-sm font-medium text-gray-900 mr-2">${
                                          message.sender.last_name
                                        } ${message.sender.first_name}</span>
                                        <span class="text-xs text-gray-500">${formatTime(
                                          message.created_at
                                        )}</span>
                                    </div>
                                `
                                    : `
                                    <div class="flex items-center">
                                        <span class="text-xs text-gray-500">${formatTime(
                                          message.created_at
                                        )}</span>
                                    </div>
                                `
                                }
                                <div class="bg-gray-100 rounded-lg p-3 mt-1">
                                    ${
                                    typeof message.file_url === "string"
                                        ? `
                                        <div class="mb-2">
                                            ${
                                                message.file_url.match(/\.(jpg|jpeg|png|gif)$/i)
                                                ? `<img src="${message.file_url}" alt="画像" class="max-w-full rounded">`
                                                : `<a href="${message.file_url}" target="_blank" class="text-blue-600 underline">📎 ファイルを開く</a>`
                                            }
                                        </div>
                                    `
                                        : ""
                                    }
                                    <p class="text-gray-800">${
                                      escapeHtml(message.content)
                                    }</p>
                                </div>
                            </div>
                        </div>
                    `;
          }
        });

        container.innerHTML = html;
        scrollToBottom();
      }

      // メッセージ送信
      async function sendMessage(content, fileUrl = null) {
        if (!currentChatUser || (!content.trim() && !fileUrl)) return;

        const messageData = composeMessage(
          currentUser.id,
          currentChatUser.id,
          content,
          fileUrl
        );

        try {
          await sendMessageAPI(supabase, messageData);
        } catch (error) {
          console.error("Error sending message:", error);
          alert("メッセージの送信に失敗しました");
          return;
        }

        // 入力フィールドをクリア
        document.getElementById("message-input").value = "";

        // メッセージを再読み込み
        await loadMessages(currentChatUser.id);

        // 会話一覧を更新
        await loadConversations();

        // 通知を作成
        await supabase.from("notifications").insert({
          user_id: currentChatUser.id,
          type: "message",
          title: "新しいメッセージ",
          content: `${userProfile.last_name} ${userProfile.first_name}さんからメッセージが届きました`,
          related_id: currentUser.id,
        });
      }

      // ファイルアップロード
      async function uploadFile(file, type = "files") {
        const fileExt = file.name.split(".").pop();
        const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;
        const filePath = `messages/${type}/${fileName}`;

        const { error: uploadError } = await supabase.storage
          .from("message-files")
          .upload(filePath, file);

        if (uploadError) {
          console.error("Upload error:", uploadError);
          throw new Error("ファイルのアップロードに失敗しました");
        }

        const { data } = supabase.storage
          .from("message-files")
          .getPublicUrl(filePath);

        return data.publicUrl;
      }

      // 未読メッセージを既読にする
      async function markMessagesAsRead(senderId) {
        await supabase
          .from("direct_messages")
          .update({ is_read: true })
          .eq("sender_id", senderId)
          .eq("receiver_id", currentUser.id)
          .eq("is_read", false);
      }

      // ユーザー検索
      async function searchUsers(query) {
        if (!query.trim()) return [];

        const { data: users } = await supabase
          .from("profiles")
          .select("*")
          .neq("id", currentUser.id)
          .or(`first_name.ilike.%${query}%,last_name.ilike.%${query}%`)
          .limit(10);

        return users || [];
      }

      // ユーザー情報サイドバー更新
      function updateContactInfo(user) {
        const container = document.getElementById("contact-info-content");

        container.innerHTML = `
                <div class="flex justify-center">
                    <img src="${
                      user.profile_image_url || "/api/placeholder/96/96"
                    }" alt="${user.last_name} ${
          user.first_name
        }" class="h-24 w-24 rounded-full object-cover">
                </div>
                <h3 class="font-medium text-lg text-gray-900 text-center mt-4">${
                  user.last_name
                } ${user.first_name}</h3>
                <p class="text-sm text-gray-600 text-center mt-1">${
                  locationNames[user.location] || user.location
                }</p>
                <div class="mt-2 flex justify-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">オンライン</span>
                </div>
                
                <div class="mt-6 flex justify-center space-x-2">
                    <button type="button" class="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-200" onclick="startCall('video')" title="ビデオ通話">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <button type="button" class="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-200" onclick="startCall('voice')" title="音声通話">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                    </button>
                    <a href="profile-detail.html?user=${
                      user.id
                    }" class="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-200" title="プロフィール">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </a>
                </div>
                
                ${
                  user.bio
                    ? `
                    <div class="mt-6">
                        <h4 class="font-medium text-gray-900 mb-2">プロフィール</h4>
                        <p class="text-sm text-gray-600">${user.bio}</p>
                    </div>
                `
                    : ""
                }
                
                ${
                  user.skills
                    ? `
                    <div class="mt-4">
                        <h4 class="font-medium text-gray-900 mb-2">スキル・興味</h4>
                        <div class="flex flex-wrap gap-1">
                            ${user.skills
                              .slice(0, 5)
                              .map(
                                (skill) => `
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${skill}</span>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `
                    : ""
                }
                
                <div class="mt-8 flex flex-col gap-2">
                    <button class="flex items-center justify-center px-4 py-2 border border-blue-600 rounded-lg text-blue-600 font-medium hover:bg-blue-50 transition duration-200">
                        <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                        フォローする
                    </button>
                    <button class="flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition duration-200">
                        <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" />
                        </svg>
                        報告する
                    </button>
                </div>
            `;
      }

      // 通話開始
      function startCall(type) {
        if (!currentChatUser) return;

        document.getElementById("call-user-avatar").src =
          currentChatUser.profile_image_url || "/api/placeholder/96/96";
        document.getElementById(
          "call-user-name"
        ).textContent = `${currentChatUser.last_name} ${currentChatUser.first_name}`;
        document.getElementById("call-status").textContent =
          type === "video" ? "ビデオ通話を発信中..." : "音声通話を発信中...";

        openModal("call-modal");

        // 模擬的な接続
        setTimeout(() => {
          document.getElementById("call-status").textContent = "接続されました";
        }, 2000);
      }

      // リアルタイム更新設定
      function setupRealtimeSubscriptions() {
        supabase
          .channel("messages-channel")
          .on(
            "postgres_changes",
            {
              event: "INSERT",
              schema: "public",
              table: "direct_messages",
              filter: `receiver_id=eq.${currentUser.id}`,
            },
            (payload) => {
              // 新しいメッセージを受信
              if (
                currentChatUser &&
                payload.new.sender_id === currentChatUser.id
              ) {
                loadMessages(currentChatUser.id);
                markMessagesAsRead(currentChatUser.id);
              }
              loadConversations();
            }
          )
          .on(
            "postgres_changes",
            {
              event: "UPDATE",
              schema: "public",
              table: "direct_messages",
              filter: `sender_id=eq.${currentUser.id}`,
            },
            (payload) => {
              // 既読ステータス更新
              if (
                currentChatUser &&
                payload.new.receiver_id === currentChatUser.id
              ) {
                loadMessages(currentChatUser.id);
              }
            }
          )
          .subscribe();
      }

      // ユーティリティ関数
      function formatTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString("ja-JP", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function formatMessageTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return "今";
        if (diff < 3600000) return `${Math.floor(diff / 60000)}分前`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}時間前`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)}日前`;

        return date.toLocaleDateString("ja-JP");
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function scrollToBottom() {
        const container = document.getElementById("messages-container");
        container.scrollTop = container.scrollHeight;
      }

      function showLoadingConversations() {
        document
          .getElementById("loading-conversations")
          .classList.remove("hidden");
        document
          .getElementById("conversations-content")
          .classList.add("hidden");
        document.getElementById("no-conversations").classList.add("hidden");
      }

      // イベントリスナー設定
      document
        .querySelector(".mobile-menu-button")
        .addEventListener("click", function () {
          document.querySelector(".mobile-menu").classList.toggle("hidden");
        });

      document
        .getElementById("user-menu-button")
        .addEventListener("click", function () {
          document.getElementById("user-menu").classList.toggle("hidden");
        });

      window.addEventListener("click", function (e) {
        if (!document.getElementById("user-menu-button").contains(e.target)) {
          document.getElementById("user-menu").classList.add("hidden");
        }
      });

      // モバイル用のリスト表示/非表示
      document
        .getElementById("toggle-contact-list")
        .addEventListener("click", function () {
          const contactList = document.getElementById("contact-list");
          const chatContent = document.getElementById("chat-content");

          if (contactList.classList.contains("hidden")) {
            contactList.classList.remove("hidden");
            chatContent.classList.add("hidden");
          } else {
            contactList.classList.add("hidden");
            chatContent.classList.remove("hidden");
          }
        });

      document
        .getElementById("toggle-contact-info")
        .addEventListener("click", function () {
          const contactInfo = document.getElementById("contact-info");
          const chatContent = document.getElementById("chat-content");

          if (contactInfo.classList.contains("hidden")) {
            contactInfo.classList.remove("hidden");
            chatContent.classList.add("hidden");
          } else {
            contactInfo.classList.add("hidden");
            chatContent.classList.remove("hidden");
          }
        });

      document
        .getElementById("show-contact-info")
        .addEventListener("click", function () {
          const contactInfo = document.getElementById("contact-info");
          contactInfo.classList.toggle("hidden");
        });

      // メッセージ送信
      document
        .getElementById("send-message-btn")
        .addEventListener("click", function () {
          const input = document.getElementById("message-input");
          const content = input.value.trim();
          if (content) {
            sendMessage(content);
          }
        });

      document
        .getElementById("message-input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            const content = this.value.trim();
            if (content) {
              sendMessage(content);
            }
          }
        });

      // ファイル添付
      document
        .getElementById("attach-file-btn")
        .addEventListener("click", function () {
          document.getElementById("file-input").click();
        });

      document
        .getElementById("attach-image-btn")
        .addEventListener("click", function () {
          document.getElementById("image-input").click();
        });

      document
        .getElementById("file-input")
        .addEventListener("change", async function (e) {
          const file = e.target.files[0];
          if (file) {
            try {
              const fileUrl = await uploadFile(file, "files");
              await sendMessage(`ファイル: ${file.name}`, fileUrl);
            } catch (error) {
              alert(error.message);
            }
            this.value = "";
          }
        });

      document
        .getElementById("image-input")
        .addEventListener("change", async function (e) {
          const file = e.target.files[0];
          if (file) {
            try {
              const fileUrl = await uploadFile(file, "images");
              await sendMessage("画像を送信しました", fileUrl);
            } catch (error) {
              alert(error.message);
            }
            this.value = "";
          }
        });

      // 通話関連
      document
        .getElementById("video-call-btn")
        .addEventListener("click", () => startCall("video"));
      document
        .getElementById("voice-call-btn")
        .addEventListener("click", () => startCall("voice"));
      document
        .getElementById("end-call-btn")
        .addEventListener("click", function () {
          closeModal("call-modal");
        });

      // 新規メッセージモーダル
      document
        .getElementById("new-message-btn")
        .addEventListener("click", function () {
          openModal("new-message-modal", this);
        });

      document
        .getElementById("close-new-message-modal")
        .addEventListener("click", function () {
          closeModal("new-message-modal");
        });

      document
        .getElementById("cancel-new-message")
        .addEventListener("click", function () {
          closeModal("new-message-modal");
        });

      // 宛先検索
      document
        .getElementById("recipient-search")
        .addEventListener("input", async function (e) {
          const query = e.target.value.trim();
          const suggestionsContainer = document.getElementById(
            "recipient-suggestions"
          );

          if (query.length < 2) {
            suggestionsContainer.classList.add("hidden");
            return;
          }

          const users = await searchUsers(query);

          if (users.length === 0) {
            suggestionsContainer.innerHTML =
              '<div class="p-2 text-gray-500 text-sm">ユーザーが見つかりません</div>';
            suggestionsContainer.classList.remove("hidden");
            return;
          }

          suggestionsContainer.innerHTML = users
            .map(
              (user) => `
                <div class="p-2 hover:bg-gray-100 cursor-pointer flex items-center" onclick="selectRecipient('${
                  user.id
                }')">
                    <img src="${
                      user.profile_image_url || "/api/placeholder/32/32"
                    }" alt="" class="w-8 h-8 rounded-full object-cover mr-2">
                    <div>
                        <div class="text-sm font-medium">${user.last_name} ${
                user.first_name
              }</div>
                        <div class="text-xs text-gray-500">${
                          locationNames[user.location] || user.location
                        }</div>
                    </div>
                </div>
            `
            )
            .join("");
          suggestionsContainer.classList.remove("hidden");
        });

      // 宛先選択
      function selectRecipient(userId) {
        const users = document.querySelectorAll("#recipient-suggestions > div");
        users.forEach((user) => {
          if (user.onclick && user.onclick.toString().includes(userId)) {
            selectedRecipient = userId;
            document.getElementById("recipient-search").value =
              user.querySelector(".text-sm").textContent;
            document
              .getElementById("recipient-suggestions")
              .classList.add("hidden");
          }
        });
      }

      // 新規メッセージ送信
      document
        .getElementById("send-new-message")
        .addEventListener("click", async function () {
          const message = document
            .getElementById("initial-message")
            .value.trim();

          if (!selectedRecipient || !message) {
            alert("宛先とメッセージを入力してください");
            return;
          }

          try {
            await supabase.from("direct_messages").insert({
              sender_id: currentUser.id,
              receiver_id: selectedRecipient,
              content: message,
              is_read: false,
            });

            // モーダルを閉じて、新しいチャットを開く
            document
              .getElementById("new-message-modal")
              .classList.add("hidden");
            document.getElementById("recipient-search").value = "";
            document.getElementById("initial-message").value = "";
            selectedRecipient = null;

            await loadConversations();
            await startChatWithUser(selectedRecipient);
          } catch (error) {
            console.error("Error sending message:", error);
            alert("メッセージの送信に失敗しました");
          }
        });

      // ログアウト
      document
        .getElementById("logout-link")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await supabase.auth.signOut();
          window.location.href = "login.html?message=logout";
        });

      document
        .querySelector(".logout-link-mobile")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await supabase.auth.signOut();
          window.location.href = "login.html?message=logout";
        });

      // 初期表示設定（モバイル）
      function handleResize() {
        if (window.innerWidth < 768) {
          document.getElementById("contact-list").classList.remove("hidden");
          document.getElementById("chat-content").classList.add("hidden");
          document.getElementById("contact-info").classList.add("hidden");
        } else {
          document.getElementById("contact-list").classList.remove("hidden");
          document.getElementById("chat-content").classList.remove("hidden");
        }
      }

      window.addEventListener("resize", handleResize);
      handleResize();

      // グローバル関数として公開
      window.selectConversation = selectConversation;
      window.selectRecipient = selectRecipient;
      window.startCall = startCall;
    </script>
    <script src="js/theme.js"></script>
    <script src="accessibility.js"></script>
  </body>
</html>
